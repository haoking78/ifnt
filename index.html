<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>無限翻轉人生 · IFNT</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0a2640" />
<style>
:root{--bg:#0a2640;--text:#eaf6ff;--ring:rgba(255,255,255,.12);--muted:#9fc5ff;--accent:#3B82F6;--good:#12c48b;--bad:#ef4444}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,'Segoe UI','PingFang TC','Noto Sans TC',Roboto,'Microsoft JhengHei',sans-serif;color:var(--text);background:linear-gradient(180deg,#0f2a4a,#071a2c)}
.wrap{max-width:980px;margin:0 auto;padding:18px 14px 56px}
header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
header img{width:32px;height:32px;border-radius:8px;object-fit:contain;background:#fff}
h1{margin:0;font-size:20px}.muted{color:var(--muted);font-size:12px}
.card{background:rgba(255,255,255,.05);border:1px solid var(--ring);border-radius:12px;padding:12px;margin:12px 0}
summary{cursor:pointer;list-style:none}summary::-webkit-details-marker{display:none}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}@media(max-width:720px){.row{grid-template-columns:1fr}}
.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}@media(max-width:720px){.row-3{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:rgba(255,255,255,.06);color:var(--text);outline:none}
textarea{min-height:100px;resize:vertical}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;font-weight:700;color:#fff;cursor:pointer;background:linear-gradient(180deg,var(--accent),#2a6de7)}
.btn-ghost{appearance:none;border:1px solid var(--ring);border-radius:10px;padding:10px 12px;background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:8px;background:rgba(255,255,255,.03);border:1px solid var(--ring);border-radius:12px;overflow:hidden}
th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.06);font-size:14px}th{color:#cfe7ff;text-align:left;background:rgba(255,255,255,.05)}tr:last-child td{border-bottom:none}
.progress{height:12px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;border:1px solid var(--ring)}.progress>div{height:100%;background:linear-gradient(90deg,#3B82F6,#69c7ff);width:0%}
.kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:8px}@media(max-width:720px){.kpi{grid-template-columns:repeat(2,1fr)}}
.kpi .box{background:rgba(255,255,255,.06);border:1px solid var(--ring);border-radius:10px;padding:10px}.kpi .t{font-size:12px;color:#bcdcff}.kpi .v{font-size:20px;font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="app_icon_192.png" alt="IFNT">
    <div><h1>無限翻轉人生 · IFNT</h1><div class="muted">CSV 版 v2</div></div>
  </header>

  <!-- 工具列：一次匯出四檔 -->
  <div class="actions">
    <button class="btn" id="backupAll">匯出全部 CSV（4 檔）</button>
  </div>

  <!-- ① 親自招募 1 人 -->
  <details class="card" open>
    <summary><b>① 親自招募 1 人</b></summary>
    <div class="row">
      <input id="r_date" type="date" class="input">
      <input id="r_name" type="text" class="input" placeholder="招募姓名（必填）">
    </div>
    <div class="actions">
      <button class="btn" id="r_add">新增</button>
      <button class="btn-ghost" id="r_exp">匯出 CSV</button>
      <label class="btn-ghost">匯入 CSV<input id="r_imp" type="file" accept=".csv" hidden></label>
      <button class="btn-ghost" id="r_del">刪除勾選</button>
    </div>
    <div class="kpi">
      <div class="box"><div class="t">累計人數</div><div class="v" id="r_cnt">0</div></div>
      <div class="box"><div class="t">目標</div><div class="v">1</div></div>
      <div class="box"><div class="t">狀態</div><div class="v" id="r_state">未達標</div></div>
      <div class="box"><div class="t">進度</div><div class="progress"><div id="r_bar"></div></div></div>
    </div>
    <table id="r_tbl"><thead><tr><th><input type="checkbox" id="r_all"></th><th>#</th><th>日期</th><th>姓名</th></tr></thead><tbody></tbody></table>
  </details>

  <!-- ② 零售+自購 1500BV -->
  <details class="card">
    <summary><b>② 零售＋自購 1500 BV</b></summary>
    <div class="row-3">
      <input id="b_date" type="date" class="input">
      <input id="b_cust" class="input" placeholder="顧客姓名（必填）">
      <input id="b_item" class="input" placeholder="零售品項（自行輸入）">
      <input id="b_bv" type="number" inputmode="decimal" class="input" placeholder="BV（必填）">
    </div>
    <div class="actions">
      <button class="btn" id="b_add">新增</button>
      <button class="btn-ghost" id="b_exp">匯出 CSV</button>
      <label class="btn-ghost">匯入 CSV<input id="b_imp" type="file" accept=".csv" hidden></label>
      <button class="btn-ghost" id="b_del">刪除勾選</button>
    </div>
    <div class="kpi">
      <div class="box"><div class="t">累計 BV</div><div class="v" id="b_sum">0</div></div>
      <div class="box"><div class="t">目標</div><div class="v">1500</div></div>
      <div class="box"><div class="t">尚差</div><div class="v" id="b_left">1500</div></div>
      <div class="box"><div class="t">進度</div><div class="progress"><div id="b_bar"></div></div></div>
    </div>
    <table id="b_tbl"><thead><tr><th><input type="checkbox" id="b_all"></th><th>#</th><th>日期</th><th>顧客</th><th>品項</th><th>BV</th></tr></thead><tbody></tbody></table>
  </details>

  <!-- ③ 家庭轉移消費 300IBV -->
  <details class="card">
    <summary><b>③ 家庭轉移消費 300 IBV</b></summary>
    <div class="row-3">
      <input id="i_date" type="date" class="input">
      <input id="i_name" class="input" placeholder="顧客或自己（必填）">
      <input id="i_item" class="input" placeholder="消費品項（自行輸入）">
      <input id="i_ibv" type="number" inputmode="decimal" class="input" placeholder="IBV（必填）">
    </div>
    <div class="actions">
      <button class="btn" id="i_add">新增</button>
      <button class="btn-ghost" id="i_exp">匯出 CSV</button>
      <label class="btn-ghost">匯入 CSV<input id="i_imp" type="file" accept=".csv" hidden></label>
      <button class="btn-ghost" id="i_del">刪除勾選</button>
    </div>
    <div class="kpi">
      <div class="box"><div class="t">累計 IBV</div><div class="v" id="i_sum">0</div></div>
      <div class="box"><div class="t">目標</div><div class="v">300</div></div>
      <div class="box"><div class="t">尚差</div><div class="v" id="i_left">300</div></div>
      <div class="box"><div class="t">進度</div><div class="progress"><div id="i_bar"></div></div></div>
    </div>
    <table id="i_tbl"><thead><tr><th><input type="checkbox" id="i_all"></th><th>#</th><th>日期</th><th>姓名</th><th>品項</th><th>IBV</th></tr></thead><tbody></tbody></table>
  </details>

  <!-- ④ 312 互動名單 -->
  <details class="card">
    <summary><b>④ 312 互動名單</b></summary>
    <div class="row-3">
      <select id="c_city" class="input">
        <option value="">居住縣市</option>
        <option>臺北市</option><option>新北市</option><option>基隆市</option><option>桃園市</option>
        <option>新竹市</option><option>新竹縣</option><option>苗栗縣</option><option>臺中市</option>
        <option>彰化縣</option><option>南投縣</option><option>雲林縣</option><option>嘉義市</option>
        <option>嘉義縣</option><option>臺南市</option><option>高雄市</option><option>屏東縣</option>
        <option>宜蘭縣</option><option>花蓮縣</option><option>臺東縣</option><option>澎湖縣</option>
        <option>金門縣</option><option>連江縣</option>
      </select>
      <input id="c_name" class="input" placeholder="姓名">
      <input id="c_group" class="input" placeholder="族群">
      <input id="c_date" type="date" class="input">
    </div>
    <div class="row" style="margin-top:8px"><textarea id="c_note" placeholder="互動情況 / 備註"></textarea></div>
    <div class="actions">
      <button class="btn" id="c_add">新增</button>
      <button class="btn-ghost" id="c_exp">匯出 CSV</button>
      <label class="btn-ghost">匯入 CSV<input id="c_imp" type="file" accept=".csv" hidden></label>
      <button class="btn-ghost" id="c_del">刪除勾選</button>
    </div>
    <table id="c_tbl"><thead><tr><th><input type="checkbox" id="c_all"></th><th>#</th><th>日期</th><th>縣市</th><th>姓名</th><th>族群</th><th>備註</th></tr></thead><tbody></tbody></table>
  </details>

  <p class="muted">資料保存在本機（localStorage）。可用「匯出 CSV」備份與跨裝置轉移。</p>
</div>

<script>
// ===== CSV helpers =====
function toCSV(rows, headers){const esc=v=>'"'+String(v??'').replace(/"/g,'""')+'"';const head=headers.map(esc).join(',');const body=rows.map(r=>headers.map(h=>esc(r[h])).join(',')).join('\n');return head+'\n'+body;}
function downloadCSV(filename,csv){const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);}
function parseCSV(file,headers,onRows){const fr=new FileReader();fr.onload=e=>{const lines=e.target.result.replace(/\r/g,'').split('\n').filter(Boolean);if(!lines.length)return alert('CSV 為空');const head=lines[0].split(',').map(s=>s.replace(/^"|"$/g,'').trim());if(head.join(',')!==headers.join(','))return alert('欄位不符：\n期待：'+headers.join(','));const rows=lines.slice(1).map(line=>{const cols=line.match(/(".*?"|[^,]+)(?=,|$)/g).map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'));const obj={};headers.forEach((h,i)=>obj[h]=cols[i]??'');return obj;});onRows(rows);};fr.readAsText(file,'utf-8');}

// ===== storage =====
const K={r:'ifnt_ufo1',b:'ifnt_ufo2',i:'ifnt_ufo3',c:'ifnt_312'};
const get=k=>JSON.parse(localStorage.getItem(k)||'[]');const set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const fmt=n=>(Number(n)||0).toLocaleString();

// ===== renderers =====
function renderRecruit(){const arr=get(K.r).sort((a,b)=>(b.date||'').localeCompare(a.date||''));const tb=document.querySelector('#r_tbl tbody');tb.innerHTML='';arr.forEach((r,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td><input type="checkbox" data-i="${i}"></td><td>${i+1}</td><td>${r.date||''}</td><td>${r.recruit_name||''}</td>`;tb.appendChild(tr);});document.getElementById('r_cnt').textContent=arr.length;document.getElementById('r_state').textContent=arr.length>=1?'已達標':'未達標';document.getElementById('r_bar').style.width=Math.min(100,arr.length*100)+'%';}
function renderBV(){const arr=get(K.b).sort((a,b)=>(b.date||'').localeCompare(a.date||''));const tb=document.querySelector('#b_tbl tbody');tb.innerHTML='';arr.forEach((r,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td><input type="checkbox" data-i="${i}"></td><td>${i+1}</td><td>${r.date||''}</td><td>${r.customer_name||''}</td><td>${r.item_name||''}</td><td>${fmt(r.bv)}</td>`;tb.appendChild(tr);});const s=arr.reduce((t,x)=>t+(+x.bv||0),0);document.getElementById('b_sum').textContent=fmt(s);document.getElementById('b_left').textContent=fmt(Math.max(0,1500-s));document.getElementById('b_bar').style.width=Math.min(100,(s/1500)*100)+'%';document.getElementById('b_bar').title=s+'/1500';}
function renderIBV(){const arr=get(K.i).sort((a,b)=>(b.date||'').localeCompare(a.date||''));const tb=document.querySelector('#i_tbl tbody');tb.innerHTML='';arr.forEach((r,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td><input type="checkbox" data-i="${i}"></td><td>${i+1}</td><td>${r.date||''}</td><td>${r.person_or_self||''}</td><td>${r.item_name||''}</td><td>${fmt(r.ibv)}</td>`;tb.appendChild(tr);});const s=arr.reduce((t,x)=>t+(+x.ibv||0),0);document.getElementById('i_sum').textContent=fmt(s);document.getElementById('i_left').textContent=fmt(Math.max(0,300-s));document.getElementById('i_bar').style.width=Math.min(100,(s/300)*100)+'%';document.getElementById('i_bar').title=s+'/300';}
function renderCRM(){const arr=get(K.c).sort((a,b)=>(b.date||'').localeCompare(a.date||''));const tb=document.querySelector('#c_tbl tbody');tb.innerHTML='';arr.forEach((r,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td><input type="checkbox" data-i="${i}"></td><td>${i+1}</td><td>${r.date||''}</td><td>${r.city||''}</td><td>${r.name||''}</td><td>${r.group||''}</td><td>${(r.note||'').replace(/\n/g,'<br>')}</td>`;tb.appendChild(tr);});}

// ===== add handlers =====
document.getElementById('r_add').onclick=()=>{const date=document.getElementById('r_date').value||new Date().toISOString().slice(0,10);const name=document.getElementById('r_name').value.trim();if(!name)return alert('請輸入招募姓名');const arr=get(K.r);arr.push({date,recruit_name:name});set(K.r,arr);document.getElementById('r_name').value='';renderRecruit();};
document.getElementById('b_add').onclick=()=>{const date=document.getElementById('b_date').value||new Date().toISOString().slice(0,10);const customer=document.getElementById('b_cust').value.trim();const item=document.getElementById('b_item').value.trim();const bv=Number(document.getElementById('b_bv').value);if(!customer||!bv)return alert('請輸入顧客姓名與 BV');const arr=get(K.b);arr.push({date,customer_name:customer,item_name:item,bv});set(K.b,arr);document.getElementById('b_cust').value='';document.getElementById('b_item').value='';document.getElementById('b_bv').value='';renderBV();};
document.getElementById('i_add').onclick=()=>{const date=document.getElementById('i_date').value||new Date().toISOString().slice(0,10);const name=document.getElementById('i_name').value.trim();const item=document.getElementById('i_item').value.trim();const ibv=Number(document.getElementById('i_ibv').value);if(!name||!ibv)return alert('請輸入姓名與 IBV');const arr=get(K.i);arr.push({date,person_or_self:name,item_name:item,ibv});set(K.i,arr);document.getElementById('i_name').value='';document.getElementById('i_item').value='';document.getElementById('i_ibv').value='';renderIBV();};
document.getElementById('c_add').onclick=()=>{const date=document.getElementById('c_date').value||new Date().toISOString().slice(0,10);const city=document.getElementById('c_city').value;const name=document.getElementById('c_name').value.trim();const group=document.getElementById('c_group').value.trim();const note=document.getElementById('c_note').value.trim();if(!name)return alert('請輸入姓名');const arr=get(K.c);arr.push({date,city,name,group,note});set(K.c,arr);document.getElementById('c_note').value='';renderCRM();};

// ===== export/import per section =====
const H1=['date','recruit_name'];document.getElementById('r_exp').onclick=()=>downloadCSV('ufo1_recruits.csv',toCSV(get(K.r),H1));document.getElementById('r_imp').onchange=e=>{const f=e.target.files[0];if(!f)return;parseCSV(f,H1,rows=>{set(K.r,rows);renderRecruit();alert('UFO1 匯入完成')});e.target.value='';};
const H2=['date','customer_name','item_name','bv'];document.getElementById('b_exp').onclick=()=>downloadCSV('ufo2_bv.csv',toCSV(get(K.b),H2));document.getElementById('b_imp').onchange=e=>{const f=e.target.files[0];if(!f)return;parseCSV(f,H2,rows=>{set(K.b,rows);renderBV();alert('UFO2 匯入完成')});e.target.value='';};
const H3=['date','person_or_self','item_name','ibv'];document.getElementById('i_exp').onclick=()=>downloadCSV('ufo3_ibv.csv',toCSV(get(K.i),H3));document.getElementById('i_imp').onchange=e=>{const f=e.target.files[0];if(!f)return;parseCSV(f,H3,rows=>{set(K.i,rows);renderIBV();alert('UFO3 匯入完成')});e.target.value='';};
const HC=['date','city','name','group','note'];document.getElementById('c_exp').onclick=()=>downloadCSV('crm312.csv',toCSV(get(K.c),HC));document.getElementById('c_imp').onchange=e=>{const f=e.target.files[0];if(!f)return;parseCSV(f,HC,rows=>{set(K.c,rows);renderCRM();alert('312 互動名單匯入完成')});e.target.value='';};

// ===== bulk delete =====
function delChecked(key, sel){const arr=get(key);const idx=[...document.querySelectorAll(sel+' tbody input[type=checkbox]:checked')].map(el=>+el.dataset.i);if(!idx.length)return alert('請先勾選要刪除的項目');const kept=arr.filter((_,i)=>!idx.includes(i));set(key,kept);(sel.includes('#r_')?renderRecruit:sel.includes('#b_')?renderBV:sel.includes('#i_')?renderIBV:renderCRM)();}
document.getElementById('r_del').onclick=()=>delChecked(K.r,'#r_tbl');
document.getElementById('b_del').onclick=()=>delChecked(K.b,'#b_tbl');
document.getElementById('i_del').onclick=()=>delChecked(K.i,'#i_tbl');
document.getElementById('c_del').onclick=()=>delChecked(K.c,'#c_tbl');

// ===== select all =====
document.getElementById('r_all').onchange=e=>document.querySelectorAll('#r_tbl tbody input[type=checkbox]').forEach(c=>c.checked=e.target.checked);
document.getElementById('b_all').onchange=e=>document.querySelectorAll('#b_tbl tbody input[type=checkbox]').forEach(c=>c.checked=e.target.checked);
document.getElementById('i_all').onchange=e=>document.querySelectorAll('#i_tbl tbody input[type=checkbox]').forEach(c=>c.checked=e.target.checked);
document.getElementById('c_all').onchange=e=>document.querySelectorAll('#c_tbl tbody input[type=checkbox]').forEach(c=>c.checked=e.target.checked);

// ===== export all (download 4 CSVs) =====
document.getElementById('backupAll').onclick=()=>{
  document.getElementById('r_exp').click();
  document.getElementById('b_exp').click();
  document.getElementById('i_exp').click();
  document.getElementById('c_exp').click();
  alert('已下載 4 份 CSV（ufo1_recruits, ufo2_bv, ufo3_ibv, crm312）');
};

// initial
renderRecruit();renderBV();renderIBV();renderCRM();
</script>
</body>
</html>
