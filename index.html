<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="manifest" href="manifest.json">
<title>IFNT · 無限翻轉人生（312 互動名單 v5）</title>
<style>
*{box-sizing:border-box}
:root{
  --bg:#0b2233;
  --panel:#102a3d;
  --muted:#8fb3c7;
  --text:#e6f2f9;
  --primary:#14b8a6;
  --accent:#0ea5e9;
  --danger:#ef4444;
  --chip:#0b3750;
  --soft:#11425d;
}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,'PingFang TC','Noto Sans TC',Segoe UI,Roboto,Helvetica,Arial}
.app{max-width:980px;margin:0 auto;padding:16px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.logo{width:36px;height:36px;border-radius:8px;background:#000 url('app_icon_192.png') center/cover no-repeat}
h1{font-size:20px;margin:0}
.card{background:var(--panel);border:1px solid var(--soft);border-radius:14px;padding:16px;margin:16px 0;box-shadow:0 6px 24px rgba(0,0,0,.25) inset}
h3{margin:0 0 10px 0;font-size:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{display:flex;flex-direction:column;gap:6px;min-width:0}
.field.col-2{grid-column:span 2}
label{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px}
.caret{font-size:12px;opacity:.7}
input,select,textarea,button{
  width:100%;border:1px solid var(--soft);background:#0f2536;color:var(--text);
  border-radius:10px;padding:12px 12px;font-size:16px;outline:none
}
textarea{resize:vertical}
button{cursor:pointer;transition:.15s}
button.primary{background:var(--accent);border-color:transparent;color:#002234;font-weight:700}
button.ghost{background:transparent}
button.danger{background:var(--danger);border-color:transparent;color:white}
button.mini{width:auto;padding:6px 10px;border-radius:8px;font-size:13px}
hr.soft{border:none;border-top:1px dashed var(--soft);margin:14px 0}
.list-header,.list-row{display:grid;grid-template-columns:40px 90px 1fr 1fr 130px 70px 90px;gap:10px;align-items:center}
.list-header{color:var(--muted);font-size:13px;margin-bottom:8px}
.list-row{padding:10px 8px;border-radius:10px;background:#0f2536;border:1px solid var(--soft);margin-bottom:8px}
.detail.hidden{display:none}
.detail{margin-top:8px;background:#0f2536;border:1px solid var(--soft);border-radius:12px;padding:12px}
.detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.chip{background:var(--chip);padding:6px 10px;border-radius:999px;margin-right:6px;font-size:12px}
.chip.strong{background:var(--accent);color:#002234;font-weight:800}
.timeline{display:flex;flex-direction:column;gap:10px}
.tl-item{display:grid;grid-template-columns:120px 1fr 80px;gap:10px;align-items:start;background:#0d2130;border:1px solid var(--soft);border-radius:10px;padding:10px}
.tl-date{font-weight:700;color:#c7e7ff}
.tl-note{white-space:pre-wrap;line-height:1.5}
.toolbar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.hint{color:var(--muted);font-weight:400}
@media (max-width:720px){
  .grid{grid-template-columns:1fr}
  .field.col-2{grid-column:span 1}
  .list-header,.list-row{grid-template-columns:32px 70px 1fr 1fr 120px 60px 80px}
  .tl-item{grid-template-columns:100px 1fr 70px}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo"></div>
    <h1>IFNT · 無限翻轉人生（穩定版 · 312 互動名單 v5）</h1>
  </div>

  <!-- Section 312 -->
  <section id="sec-312" class="card">
    <h3>④ 312 互動名單</h3>
    <div class="grid">
      <div class="field">
        <label>居住縣市</label>
        <select id="c_city_ddl"></select>
      </div>
      <div class="field">
        <label>姓名 <span class="hint">（可選清單或自行輸入）</span> <span class="caret">▼</span></label>
        <input id="c_name" list="nameList" placeholder="輸入或選擇姓名" autocomplete="off">
        <datalist id="nameList"></datalist>
      </div>
      <div class="field">
        <label>族群 / 關係 <span class="caret">▼</span></label>
        <input id="c_group" list="groupList" placeholder="例如：國小同學、客戶、親戚" autocomplete="off">
        <datalist id="groupList"></datalist>
      </div>
      <div class="field">
        <label>互動日期</label>
        <input id="c_date" type="date">
      </div>
      <div class="field col-2">
        <label>互動情況 / 備註（可輸入很多內容）</label>
        <textarea id="c_note" rows="3" placeholder="互動內容、需求、跟進事項…"></textarea>
      </div>
      <div class="field col-2">
        <button id="btnAddOrAppend" class="primary">新增 / 累加互動</button>
        <button id="btnClearPerson" class="ghost">清空欄位</button>
      </div>
    </div>

    <hr class="soft">

    <div class="list-header">
      <div>#</div><div>縣市</div><div>姓名</div><div>族群</div><div>最近互動日</div><div>次數</div><div>操作</div>
    </div>
    <div id="personList" class="list-body"></div>

    <div id="personDetail" class="detail hidden">
      <div class="detail-header">
        <div>
          <span id="d_city" class="chip"></span>
          <span id="d_name" class="chip strong"></span>
          <span id="d_group" class="chip"></span>
          <span id="d_count" class="chip">共 0 次互動</span>
        </div>
        <button id="btnCloseDetail" class="ghost">收起詳情</button>
      </div>
      <div id="timeline" class="timeline"></div>
      <div class="detail-actions" style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;">
        <button id="btnDeletePerson" class="danger">刪除這位的所有互動</button>
        <button id="btnExportPerson" class="ghost">匯出這位的互動 CSV</button>
      </div>
    </div>

    <div class="toolbar">
      <button id="btnExportPeople" class="ghost">匯出「人彙總」CSV</button>
      <button id="btnExportInteractions" class="ghost">匯出「互動明細」CSV</button>
    </div>
  </section>
</div>

<script>
const STORAGE_KEY = 'ifnt_people_v1';
const OLD_KEY = 'ifnt_312_list';
const cityListTW = ["\u57fa\u9686\u5e02", "\u81fa\u5317\u5e02", "\u65b0\u5317\u5e02", "\u6843\u5712\u5e02", "\u65b0\u7af9\u5e02", "\u65b0\u7af9\u7e23", "\u82d7\u6817\u7e23", "\u81fa\u4e2d\u5e02", "\u5f70\u5316\u7e23", "\u5357\u6295\u7e23", "\u96f2\u6797\u7e23", "\u5609\u7fa9\u5e02", "\u5609\u7fa9\u7e23", "\u81fa\u5357\u5e02", "\u9ad8\u96c4\u5e02", "\u5c4f\u6771\u7e23", "\u5b9c\u862d\u7e23", "\u82b1\u84ee\u7e23", "\u81fa\u6771\u7e23", "\u6f8e\u6e56\u7e23", "\u91d1\u9580\u7e23", "\u9023\u6c5f\u7e23"]

let PEOPLE = {}

const el = {
  city:  document.getElementById('c_city_ddl'),
  name:  document.getElementById('c_name'),
  group: document.getElementById('c_group'),
  date:  document.getElementById('c_date'),
  note:  document.getElementById('c_note'),
  btnAdd: document.getElementById('btnAddOrAppend'),
  btnClear: document.getElementById('btnClearPerson'),
  list:  document.getElementById('personList'),
  detail: document.getElementById('personDetail'),
  d_city: document.getElementById('d_city'),
  d_name: document.getElementById('d_name'),
  d_group: document.getElementById('d_group'),
  d_count: document.getElementById('d_count'),
  timeline: document.getElementById('timeline'),
  btnCloseDetail: document.getElementById('btnCloseDetail'),
  btnDeletePerson: document.getElementById('btnDeletePerson'),
  btnExportPerson: document.getElementById('btnExportPerson'),
  nameList: document.getElementById('nameList'),
  groupList: document.getElementById('groupList'),
  btnExportPeople: document.getElementById('btnExportPeople'),
  btnExportInteractions: document.getElementById('btnExportInteractions'),
};

function initCityDDL() {
  el.city.innerHTML = cityListTW.map(c => `<option value="${c}">${c}</option>`).join('');
}

function load() {
  const raw = localStorage.getItem(STORAGE_KEY);
  PEOPLE = raw ? JSON.parse(raw) : {}
}
function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(PEOPLE)) }

function migrateOld() {
  const old = localStorage.getItem(OLD_KEY);
  if (!old) return;
  try {
    const arr = JSON.parse(old);
    arr.forEach(row => {
      const key = row.name?.trim();
      if (!key) return;
      if (!PEOPLE[key]) PEOPLE[key] = { city: row.city||'', group: row.group||'', interactions: [] }
      PEOPLE[key].interactions.push({ date: row.date||'', note: row.note||'' });
      if (row.group) PEOPLE[key].group = row.group;
      if (row.city)  PEOPLE[key].city  = row.city;
    });
    save();
    localStorage.removeItem(OLD_KEY);
  } catch(e){}
}

function ensureToday() {
  const t = new Date();
  const m = String(t.getMonth()+1).padStart(2,'0');
  const d = String(t.getDate()).padStart(2,'0');
  el.date.value = `${t.getFullYear()}-${m}-${d}`
}

function renderNameGroupDatalists() {
  const names = Object.keys(PEOPLE).sort();
  el.nameList.innerHTML = names.map(n => `<option value="${n}"></option>`).join('');
  const groups = Array.from(new Set(Object.values(PEOPLE).map(p=>p.group).filter(Boolean))).sort();
  el.groupList.innerHTML = groups.map(g => `<option value="${g}"></option>`).join('');
}

function renderList() {
  const rows = Object.entries(PEOPLE).map(([name,p])=>({
    name, city:p.city||'—', group:p.group||'—',
    last: p.interactions.length ? (p.interactions[p.interactions.length-1].date||'—') : '—',
    cnt: p.interactions.length
  })).sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'));

  el.list.innerHTML = rows.map((r,i)=>`
    <div class="list-row">
      <div>${i+1}</div>
      <div>${r.city}</div>
      <div>${r.name}</div>
      <div>${r.group}</div>
      <div>${r.last}</div>
      <div>${r.cnt}</div>
      <div><button class="mini" data-view="${r.name}">查看</button></div>
    </div>
  `).join('');

  el.list.querySelectorAll('button[data-view]').forEach(btn=>{
    btn.onclick = ()=> openDetail(btn.dataset.view)
  });
}

function openDetail(name) {
  const p = PEOPLE[name]; if(!p) return;
  el.detail.classList.remove('hidden');
  el.d_city.textContent = p.city || '—';
  el.d_name.textContent = name;
  el.d_group.textContent = p.group || '—';
  el.d_count.textContent = `共 ${p.interactions.length} 次互動`;

  el.timeline.innerHTML = p.interactions.map((it,i)=>`
    <div class="tl-item">
      <div class="tl-date">${it.date||'—'}</div>
      <div class="tl-note">${escapeHTML(it.note||'')}</div>
      <div class="tl-op"><button class="mini danger" data-del="${i}" data-name="${name}">刪除</button></div>
    </div>
  `).join('');

  el.timeline.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick = ()=>{
      const idx = +b.dataset.del;
      const key = b.dataset.name;
      PEOPLE[key].interactions.splice(idx,1);
      save(); renderList(); openDetail(key);
    }
  });

  el.btnDeletePerson.onclick = ()=>{
    if(confirm(`刪除「${name}」的所有互動？`)) {
      delete PEOPLE[name]; save(); renderNameGroupDatalists(); renderList(); closeDetail();
    }
  };
  el.btnExportPerson.onclick = ()=> exportPersonCSV(name);
}
function closeDetail(){ el.detail.classList.add('hidden') }

function addOrAppend(){
  const name = el.name.value.trim(); if(!name){alert('請輸入姓名');return;}
  const city = el.city.value||''; const group = el.group.value.trim();
  const date = el.date.value||''; const note = el.note.value.trim();
  if(!PEOPLE[name]) PEOPLE[name] = { city, group, interactions: [] }
  if(city) PEOPLE[name].city = city;
  if(group) PEOPLE[name].group = group;
  PEOPLE[name].interactions.push({date, note});
  save(); renderNameGroupDatalists(); renderList(); openDetail(name);
  el.note.value=''; ensureToday();
}

function clearInputs(){
  el.name.value=''; el.group.value=''; el.note.value=''; ensureToday();
}

function onNameChange(){
  const key = el.name.value.trim();
  const p = PEOPLE[key];
  if(p){
    if(p.city) el.city.value = p.city;
    if(p.group) el.group.value = p.group;
    openDetail(key);
  }
}

function exportPersonCSV(name){
  const p = PEOPLE[name]; if(!p) return;
  const rows = [['city','name','group','date','note']].concat(
    p.interactions.map(it=>[p.city||'', name, p.group||'', it.date||'', it.note||''])
  );
  downloadCSV(rows, `${name}_interactions.csv`);
}
function exportPeopleCSV(){
  const rows = [['city','name','group','last_date','count']];
  Object.entries(PEOPLE).forEach(([name,p])=>{
    const cnt = p.interactions.length; const last = cnt ? (p.interactions[cnt-1].date||'') : '';
    rows.push([p.city||'', name, p.group||'', last, String(cnt)]);
  });
  downloadCSV(rows, 'people_summary.csv');
}
function exportInteractionsCSV(){
  const rows = [['city','name','group','date','note']];
  Object.entries(PEOPLE).forEach(([name,p])=>{
    p.interactions.forEach(it=> rows.push([p.city||'', name, p.group||'', it.date||'', it.note||'']));
  });
  downloadCSV(rows, 'people_interactions.csv');
}
function downloadCSV(rows, filename){
  const csv = rows.map(r=>r.map(csvEscape).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  URL.revokeObjectURL(a.href);
}
function csvEscape(s){
  s = s==null ? '' : String(s);
  return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
}
function escapeHTML(str){
  return str.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'})[c]);
}

/* Bind & init */
el.btnAdd.onclick = addOrAppend;
el.btnClear.onclick = clearInputs;
el.name.addEventListener('change', onNameChange);
el.btnCloseDetail.onclick = closeDetail;
el.btnExportPeople.onclick = exportPeopleCSV;
el.btnExportInteractions.onclick = exportInteractionsCSV;

initCityDDL(); load(); migrateOld(); renderNameGroupDatalists(); renderList(); ensureToday();
</script>
</body>
</html>
