<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>無限翻轉人生 · IFNT</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="app_icon_192.png">
<meta name="theme-color" content="#1E88E5">
<style>
:root{
  --bg:#0b1520; --panel:#0f2233; --chip:#16344e; --ring:#244c68;
  --text:#eaf4ff; --muted:#97b6cf; --accent:#1e88e5; --accent2:#5ec8f5;
  --ok:#22d397; --bad:#ff6b6b;
  --shadow:0 10px 26px rgba(0,0,0,.35);
  --r:14px;
}
*{box-sizing:border-box}
html,body{margin:0;background:linear-gradient(180deg,#07131e,#0b1520 70%);color:var(--text);
  font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Segoe UI,Roboto,sans-serif}
.wrap{max-width:980px;margin:0 auto;padding:18px 16px 80px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;z-index:10;
  background:linear-gradient(180deg,rgba(11,21,32,.95),rgba(11,21,32,.4));backdrop-filter:blur(6px);padding:12px 0}
.hleft{display:flex;align-items:center;gap:12px}
.logo{width:38px;height:38px;border-radius:10px;background:#000 url(app_icon_192.png) center/cover no-repeat;box-shadow:inset 0 0 0 1px #244c68}
.title{font-size:20px;font-weight:800;letter-spacing:.4px}
.tag{display:inline-block;padding:4px 10px;border:1px solid var(--ring);border-radius:999px;background:var(--chip);color:var(--muted);font-size:12px}
.btn{appearance:none;border:1px solid var(--ring);background:var(--chip);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);font-weight:700}
.btn:hover{filter:brightness(1.05)}
.btn.warn{background:#3a2a00;border-color:#5b4300;color:#ffd166}
.panel{background:var(--panel);border:1px solid var(--ring);border-radius:18px;box-shadow:var(--shadow);padding:16px;margin:14px 0}
.h2{font-size:18px;margin:4px 0 12px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:740px){.grid{grid-template-columns:1fr}}
label{font-size:13px;color:var(--muted);display:block;margin:6px 2px}
.input, select, textarea{width:100%;max-width:100%;appearance:none;-webkit-appearance:none;background:rgba(255,255,255,.06);color:var(--text);
  border:1px solid var(--ring);border-radius:12px;padding:12px;font-size:16px;outline:none}
/* iOS date width fix */
input[type="date"]{width:100%!important;max-width:100%!important;appearance:none;-webkit-appearance:none}
textarea{min-height:100px;resize:vertical}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{border-bottom:1px dashed rgba(255,255,255,.14);padding:10px 8px;font-size:14px;text-align:left}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.card{background:rgba(255,255,255,.04);border:1px solid var(--ring);border-radius:14px;padding:12px}
.big{font-size:22px;font-weight:800}
.badge{display:inline-block;padding:3px 8px;border-radius:8px;font-size:12px}
.badge.ok{background:#0b3d2b;color:#92f3c6;border:1px solid #14684b}
.badge.miss{background:#3b1b1b;color:#ffb2b2;border:1px solid #5a2a2a}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
/* datalist hint icon */
.input-icon{position:relative;display:flex;align-items:center}
.input-icon input{flex:1;padding-right:28px}
.input-icon .hint{position:absolute;right:10px;color:var(--muted);font-size:12px;pointer-events:none}
.muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="hleft">
      <div class="logo"></div>
      <div class="title">無限翻轉人生 · IFNT</div>
      <span class="tag">v4 · 仅一鍵匯出 · 本機儲存</span>
    </div>
    <div class="actions">
      <button class="btn" id="btnExport">一鍵匯出 CSV</button>
      <button class="btn warn" id="btnClear">清空全部</button>
    </div>
  </div>

  <div class="panel">
    <div class="h2">🧭 進度總覽</div>
    <div class="kpi">
      <div class="card"><div class="muted">親自招募</div><div class="big" id="kpiR">0 / 1</div></div>
      <div class="card"><div class="muted">零售＋自購 BV</div><div class="big"><span id="sumBV">0</span> / 1500</div></div>
      <div class="card"><div class="muted">家庭轉移 IBV</div><div class="big"><span id="sumIBV">0</span> / 300</div></div>
    </div>
  </div>

  <!-- Recruit -->
  <div class="panel">
    <div class="h2">① 親自招募 1 人</div>
    <div class="grid">
      <div>
        <label>日期</label>
        <input type="date" id="rDate" class="input">
      </div>
      <div>
        <label>招募姓名（必填）</label>
        <div class="input-icon">
          <input list="nameList" id="rName" class="input" placeholder="輸入或選擇姓名">
          <span class="hint">▼</span>
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="addR">新增招募</button>
    </div>
    <table class="table" id="tblR"><thead><tr><th>#</th><th>日期</th><th>姓名</th><th>操作</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- BV -->
  <div class="panel">
    <div class="h2">② 零售＋自購 1500 BV</div>
    <div class="grid">
      <div>
        <label>日期</label>
        <input type="date" id="bDate" class="input">
      </div>
      <div>
        <label>顧客姓名（可空）</label>
        <div class="input-icon">
          <input list="nameList" id="bName" class="input" placeholder="輸入或選擇姓名">
          <span class="hint">▼</span>
        </div>
      </div>
      <div>
        <label>零售品項（例如：平泰秀、OPC、NAD）</label>
        <input id="bItem" class="input" placeholder="例如：平泰秀、OPC、NAD">
      </div>
      <div>
        <label>零售 BV（必填）</label>
        <input type="number" id="bBV" class="input" placeholder="例如：300">
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="addBV">新增 BV</button>
    </div>
    <div class="muted" id="leftBV">距離 1500 還差：1500 BV</div>
    <table class="table" id="tblBV"><thead><tr><th>#</th><th>日期</th><th>姓名</th><th>品項</th><th>BV</th><th>操作</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- IBV -->
  <div class="panel">
    <div class="h2">③ 家庭轉移消費 300 IBV</div>
    <div class="grid">
      <div>
        <label>日期</label>
        <input type="date" id="iDate" class="input">
      </div>
      <div>
        <label>消費對象（快選或輸入）</label>
        <div class="input-icon">
          <input list="groupList" id="iPerson" class="input" placeholder="例如：自己、家人、朋友">
          <span class="hint">▼</span>
        </div>
      </div>
      <div>
        <label>消費品項（例如：保健品、家電、日用品）</label>
        <input id="iItem" class="input" placeholder="例如：保健品、家電、日用品">
      </div>
      <div>
        <label>IBV（必填）</label>
        <input type="number" id="iIBV" class="input" placeholder="例如：20">
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="addIBV">新增 IBV</button>
    </div>
    <div class="muted" id="leftIBV">距離 300 還差：300 IBV</div>
    <table class="table" id="tblIBV"><thead><tr><th>#</th><th>日期</th><th>對象</th><th>品項</th><th>IBV</th><th>操作</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- Contacts -->
  <div class="panel">
    <div class="h2">④ 312 互動名單</div>
    <div class="grid">
      <div>
        <label>居住縣市</label>
        <select id="cCity" class="input"></select>
      </div>
      <div>
        <label>姓名（快選或輸入，必填）</label>
        <div class="input-icon">
          <input list="nameList" id="cName" class="input" placeholder="輸入或選擇姓名">
          <span class="hint">▼</span>
        </div>
      </div>
      <div>
        <label>族群 / 關係（例如：國小同學、客戶、親戚）</label>
        <div class="input-icon">
          <input list="groupList" id="cGroup" class="input" placeholder="例如：國小同學、客戶、親戚">
          <span class="hint">▼</span>
        </div>
      </div>
      <div>
        <label>互動日期</label>
        <input type="date" id="cDate" class="input">
      </div>
    </div>
    <label>互動情況 / 備註（可輸入很多內容）</label>
    <textarea id="cNote" class="input" placeholder="互動內容、對方狀況、下次跟進點…"></textarea>
    <div class="actions">
      <button class="btn" id="addC">新增 / 更新互動</button>
    </div>
    <table class="table" id="tblC"><thead><tr><th>#</th><th>縣市</th><th>姓名</th><th>族群</th><th>日期</th><th>內容</th><th>操作</th></tr></thead><tbody></tbody></table>
  </div>

  <datalist id="nameList"></datalist>
  <datalist id="groupList"></datalist>
</div>

<script>
const $ = s=>document.querySelector(s);
const $$ = s=>[...document.querySelectorAll(s)];
const today = ()=>{const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`}

const KEY='ifnt-v4';
let DB = JSON.parse(localStorage.getItem(KEY) || '{"recruits":[],"bvs":[],"ibvs":[],"contacts":[],"names":[],"groups":[]}');
const counties = ["基隆市","臺北市","新北市","桃園市","新竹市","新竹縣","苗栗縣","臺中市","彰化縣","南投縣","雲林縣","嘉義市","嘉義縣","臺南市","高雄市","屏東縣","宜蘭縣","花蓮縣","臺東縣","澎湖縣","金門縣","連江縣"];
$('#cCity').innerHTML = '<option value="">請選擇</option>' + counties.map(c=>`<option>${c}</option>`).join('');

['rDate','bDate','iDate','cDate'].forEach(id=>{ const el=$('#'+id); if(el) el.value=today(); });

function save(){ localStorage.setItem(KEY, JSON.stringify(DB)); render(); }
function addName(n){ if(n && !DB.names.includes(n)) DB.names.push(n); }
function addGroup(g){ if(g && !DB.groups.includes(g)) DB.groups.push(g); }
function renderLists(){
  $('#nameList').innerHTML = DB.names.map(v=>`<option value="${v}">`).join('');
  $('#groupList').innerHTML = DB.groups.map(v=>`<option value="${v}">`).join('');
}
function renderKPI(){
  $('#kpiR').textContent = `${DB.recruits.length} / 1`;
  const bv=DB.bvs.reduce((a,b)=>a+(Number(b.bv)||0),0);
  const ibv=DB.ibvs.reduce((a,b)=>a+(Number(b.ibv)||0),0);
  $('#sumBV').textContent=bv; $('#sumIBV').textContent=ibv;
  $('#leftBV').textContent = `距離 1500 還差：${Math.max(0,1500-bv)} BV`;
  $('#leftIBV').textContent = `距離 300 還差：${Math.max(0,300-ibv)} IBV`;
}
function renderTables(){
  // recruits
  const tbR = $('#tblR tbody'); tbR.innerHTML='';
  DB.recruits.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${r.date||''}</td><td>${r.name||''}</td><td><button class="btn" data-act="del" data-type="r" data-i="${i}">刪除</button></td>`;
    tbR.appendChild(tr);
  });
  // bvs
  const tbB = $('#tblBV tbody'); tbB.innerHTML='';
  DB.bvs.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${r.date||''}</td><td>${r.name||''}</td><td>${r.item||''}</td><td>${r.bv||0}</td><td><button class="btn" data-act="del" data-type="b" data-i="${i}">刪除</button></td>`;
    tbB.appendChild(tr);
  });
  // ibvs
  const tbI = $('#tblIBV tbody'); tbI.innerHTML='';
  DB.ibvs.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${r.date||''}</td><td>${r.person||''}</td><td>${r.item||''}</td><td>${r.ibv||0}</td><td><button class="btn" data-act="del" data-type="i" data-i="${i}">刪除</button></td>`;
    tbI.appendChild(tr);
  });
  // contacts
  const tbC = $('#tblC tbody'); tbC.innerHTML='';
  DB.contacts.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${r.city||''}</td><td>${r.name||''}</td><td>${r.group||''}</td><td>${r.date||''}</td><td>${(r.note||'').replace(/\\n/g,'<br>')}</td><td><button class="btn" data-act="del" data-type="c" data-i="${i}">刪除</button></td>`;
    tbC.appendChild(tr);
  });
}
function render(){ renderLists(); renderKPI(); renderTables(); }
render();

// events
document.addEventListener('click', (e)=>{
  const t = e.target; const act=t.getAttribute('data-act');
  if(act==='del'){
    const typ=t.getAttribute('data-type'); const i=+t.getAttribute('data-i');
    if(typ==='r') DB.recruits.splice(i,1);
    if(typ==='b') DB.bvs.splice(i,1);
    if(typ==='i') DB.ibvs.splice(i,1);
    if(typ==='c') DB.contacts.splice(i,1);
    save();
  }
});

$('#addR').onclick = ()=>{
  const date=$('#rDate').value||today(); const name=$('#rName').value.trim();
  if(!name){ alert('請輸入招募姓名'); return; }
  DB.recruits.push({date,name}); addName(name); save();
  $('#rName').value='';
};
$('#addBV').onclick = ()=>{
  const date=$('#bDate').value||today(); const name=$('#bName').value.trim();
  const item=$('#bItem').value.trim(); const bv=Number($('#bBV').value||0);
  if(!bv){ alert('請輸入 BV'); return; }
  DB.bvs.push({date,name,item,bv}); if(name) addName(name); save();
  $('#bName').value=''; $('#bItem').value=''; $('#bBV').value='';
};
$('#addIBV').onclick = ()=>{
  const date=$('#iDate').value||today(); const person=$('#iPerson').value.trim();
  const item=$('#iItem').value.trim(); const ibv=Number($('#iIBV').value||0);
  if(!ibv){ alert('請輸入 IBV'); return; }
  DB.ibvs.push({date,person,item,ibv}); if(person) addGroup(person); save();
  $('#iPerson').value=''; $('#iItem').value=''; $('#iIBV').value='';
};
$('#addC').onclick = ()=>{
  const city=$('#cCity').value; const name=$('#cName').value.trim();
  const group=$('#cGroup').value.trim(); const date=$('#cDate').value||today(); const note=$('#cNote').value.trim();
  if(!name){ alert('請輸入姓名'); return; }
  DB.contacts.push({city,name,group,date,note}); if(name) addName(name); if(group) addGroup(group); save();
  $('#cNote').value='';
};

$('#btnExport').onclick = ()=>{
  const rows=[["section","date","name","item_or_group","amount","city","note"]];
  DB.recruits.forEach(x=>rows.push(["recruit",x.date||"",x.name||"","","","",""]));
  DB.bvs.forEach(x=>rows.push(["bv",x.date||"",x.name||"",x.item||"",x.bv||0,"",""]));
  DB.ibvs.forEach(x=>rows.push(["ibv",x.date||"",x.person||"",x.item||"",x.ibv||0,"",""]));
  DB.contacts.forEach(x=>rows.push(["contact",x.date||"",x.name||"",x.group||"","",x.city||"", (x.note||"").replace(/\n/g,' ')]));
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\r\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `IFNT_export_${new Date().toISOString().slice(0,10)}.csv`; a.click();
};

$('#btnClear').onclick = ()=>{
  if(!confirm('確定要清空本機所有資料？')) return;
  DB={"recruits":[],"bvs":[],"ibvs":[],"contacts":[],"names":[],"groups":[]};
  localStorage.setItem(KEY, JSON.stringify(DB)); render();
};
</script>
</body>
</html>
