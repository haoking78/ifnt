<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>IFNT Â· ç„¡é™ç¿»è½‰äººç”Ÿ v6.1</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b2a3c"/>
  <style>
    :root{
      --bg:#071b27; --card:#0e2f44; --muted:#9fb8c7; --line:#123a52; --text:#dfeaf0;
      --accent:#49b6ff; --accent2:#1f99e6; --ok:#22c55e; --bad:#ef4444;
      --field-bg:#0e2a36; --field-border:#274c5e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC",Segoe UI,Roboto,Arial;
         background:radial-gradient(1200px 700px at 60% -10%,#133a52,transparent 60%) , var(--bg); color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:24px 16px 80px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    header img{width:36px;height:36px;border-radius:10px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 16px}
    .tab{padding:10px 14px;border:1px solid var(--line);background:linear-gradient(180deg,#11354a,#0c2636);border-radius:12px;cursor:pointer;color:#cfe3ee;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    .tab.active{background:linear-gradient(180deg,#1b5172,#143f59);color:#fff;outline:2px solid var(--accent);}
    .card{background:linear-gradient(180deg,#11354a,#0f2d41);border:1px solid var(--line);border-radius:16px;padding:14px 14px 10px;box-shadow:0 10px 30px rgba(0,0,0,.35);margin-bottom:16px}
    .title{font-size:18px;margin:0 0 10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg,var(--accent),var(--accent2));color:#052231;font-weight:700;cursor:pointer}
    .btn.secondary{background:linear-gradient(180deg,#143545,#0e2a36);color:#dfeaf0}
    .btn.ok{background:linear-gradient(180deg,#28d07f,#16a45c);color:#052a1a}
    .btn.warn{background:linear-gradient(180deg,#ffd162,#ffb23a);color:#402300}
    .btn.danger{background:linear-gradient(180deg,#ff7a8b,#ff586c);color:#2b0f14}
    .kpi{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
    .kpi .box{flex:1;min-width:160px;background:linear-gradient(180deg,#0f2d41,#0c2636);border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .val{font-size:20px;font-weight:800}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left}
    th{color:#bcd5e2;font-weight:700}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .muted{color:var(--muted)}
    /* v6: çµ±ä¸€æ¬„ä½èˆ‡æ—¥æœŸå¯¬åº¦ */
    .field, .field * { box-sizing: border-box; }
    .field{ margin:8px 0; }
    .field label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px 2px}
    .field input[type="text"],
    .field input[type="number"],
    .field input[type="date"],
    .field select,
    .field textarea{
      width:100%;height:56px;padding:14px 16px;border-radius:14px;border:1px solid var(--field-border);background:var(--field-bg);color:var(--text);display:block;
    }
    .field textarea{height:120px;resize:vertical;line-height:1.55}
    .field input[type="date"]{-webkit-appearance:none;appearance:none;line-height:28px}
    .date-wrap{width:100%}.date-wrap input[type="date"]{width:100%}
    /* é”æ¨™å¾½ç«  + å½©å¸¶ */
    .achieve-badge{display:inline-flex;align-items:center;gap:.4rem;padding:.2rem .6rem;border-radius:9999px;background:#16a34a;color:#fff;font-weight:700;font-size:.9rem;margin-left:.5rem}
    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:9999}
    .confetti i{position:absolute;width:10px;height:10px;will-change:transform,opacity;animation:confetti-fall 1200ms linear forwards}
    @keyframes confetti-fall{to{transform:translate(var(--tx),110vh) rotate(720deg);opacity:0}}
    @media (prefers-reduced-motion: reduce){.confetti i{animation:none}}
    .footer{color:#93b6c8;font-size:12px;text-align:center;margin:20px 0 6px}
    @media (max-width:780px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="app_icon_192.png" alt="icon">
      <div>
        <h1>IFNT Â· ç„¡é™ç¿»è½‰äººç”Ÿ v6.1</h1>
        <div class="sub">æœ¬æ©Ÿå„²å­˜ Â· æ‰‹æ©Ÿå¯å®‰è£ Â· åŒ¯å‡º CSV</div>
      </div>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="u1">â‘  æ‹›å‹Ÿ 1 äºº</div>
      <div class="tab" data-tab="u2">â‘¡ é›¶å”®ï¼‹è‡ªè³¼ 1500 BV</div>
      <div class="tab" data-tab="u3">â‘¢ å®¶åº­è½‰ç§» 300 IBV</div>
      <div class="tab" data-tab="u4">â‘£ 312 äº’å‹•åå–®</div>
    </div>

    <!-- â‘  æ‹›å‹Ÿ -->
    <section id="u1" class="card">
      <h2 class="title" id="recruitHeader">â‘  è¦ªè‡ªæ‹›å‹Ÿ 1 äºº</h2>
      <div class="grid">
        <div class="field date-wrap"><label>æ—¥æœŸ</label><input id="r-date" type="date"></div>
        <div class="field"><label>æ‹›å‹Ÿå§“å</label><input id="r-name" type="text" placeholder="è¼¸å…¥å§“å"></div>
      </div>
      <div class="right" style="margin-top:8px"><button class="btn ok" id="r-add">æ–°å¢æ‹›å‹Ÿ</button></div>
      <div class="kpi">
        <div class="box"><div class="muted">ç´¯è¨ˆäººæ•¸</div><div class="val" id="r-sum">0</div></div>
        <div class="box"><div class="muted">ç›®æ¨™</div><div class="val">1</div></div>
      </div>
      <table id="r-table"><thead><tr><th>#</th><th>æ—¥æœŸ</th><th>å§“å</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- â‘¡ BV -->
    <section id="u2" class="card" hidden>
      <h2 class="title" id="bvHeader">â‘¡ é›¶å”®ï¼‹è‡ªè³¼ 1500 BV</h2>
      <div class="grid">
        <div class="field date-wrap"><label>æ—¥æœŸ</label><input id="b-date" type="date"></div>
        <div class="field"><label>é¡§å®¢å§“å</label><input id="b-customer" list="b-customers" placeholder="è¼¸å…¥æˆ–é¸æ“‡é¡§å®¢å§“å"><datalist id="b-customers"></datalist></div>
        <div class="field"><label>é›¶å”®å“é …ï¼ˆè‡ªè¡Œè¼¸å…¥ï¼‰</label><input id="b-item" type="text" placeholder="ä¾‹å¦‚ï¼šå¹³æ³°ç§€ã€OPCã€NADâ€¦"></div>
        <div class="field"><label>é›¶å”® BV</label><input id="b-bv" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š120"></div>
      </div>
      <div class="right" style="margin-top:8px"><button class="btn ok" id="b-add">æ–°å¢ BV</button></div>
      <div class="kpi">
        <div class="box"><div class="muted">æœ¬å­£ç´¯è¨ˆ BV</div><div class="val" id="b-sum">0</div></div>
        <div class="box"><div class="muted">è· 1500 BV é‚„å·®</div><div class="val" id="b-left">1500</div></div>
      </div>
      <table id="b-table"><thead><tr><th>#</th><th>æ—¥æœŸ</th><th>å§“å</th><th>å“é …</th><th>BV</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- â‘¢ IBV -->
    <section id="u3" class="card" hidden>
      <h2 class="title" id="ibvHeader">â‘¢ å®¶åº­è½‰ç§»æ¶ˆè²» 300 IBV</h2>
      <div class="grid">
        <div class="field date-wrap"><label>æ—¥æœŸ</label><input id="i-date" type="date"></div>
        <div class="field"><label>æ¶ˆè²»å°è±¡ï¼ˆè‡ªå·±/å®¶äºº/å®¢æˆ¶â€¦ï¼‰</label><input id="i-who" list="i-who-list" placeholder="è¼¸å…¥æˆ–é¸æ“‡å°è±¡"><datalist id="i-who-list"></datalist></div>
        <div class="field"><label>æ¶ˆè²»å“é …ï¼ˆè‡ªè¡Œè¼¸å…¥ï¼‰</label><input id="i-item" type="text" placeholder="ä¾‹å¦‚ï¼šä¿å¥ã€æ¸…æ½”ã€å±…å®¶â€¦"></div>
        <div class="field"><label>IBV</label><input id="i-ibv" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š20"></div>
      </div>
      <div class="right" style="margin-top:8px"><button class="btn ok" id="i-add">æ–°å¢ IBV</button></div>
      <div class="kpi">
        <div class="box"><div class="muted">æœ¬å­£ç´¯è¨ˆ IBV</div><div class="val" id="i-sum">0</div></div>
        <div class="box"><div class="muted">è· 300 IBV é‚„å·®</div><div class="val" id="i-left">300</div></div>
      </div>
      <table id="i-table"><thead><tr><th>#</th><th>æ—¥æœŸ</th><th>å°è±¡</th><th>å“é …</th><th>IBV</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- â‘£ People -->
    <section id="u4" class="card" hidden>
      <h2 class="title">â‘£ 312 äº’å‹•åå–®</h2>
      <div class="grid">
        <div class="field"><label>å±…ä½ç¸£å¸‚</label><select id="p-city"></select></div>
        <div class="field"><label>å§“åï¼ˆå¯é¸æ¸…å–®æˆ–è‡ªè¡Œè¼¸å…¥ï¼‰</label><input id="p-name" list="p-name-list" placeholder="è¼¸å…¥æˆ–é¸æ“‡å§“å"><datalist id="p-name-list"></datalist></div>
        <div class="field"><label>æ—ç¾¤ / é—œä¿‚</label><input id="p-group" list="p-group-list" placeholder="ä¾‹å¦‚ï¼šåœ‹å°åŒå­¸ã€å®¢æˆ¶ã€è¦ªæˆš"><datalist id="p-group-list"></datalist></div>
        <div class="field date-wrap"><label>äº’å‹•æ—¥æœŸ</label><input id="p-date" type="date"></div>
      </div>
      <div class="field"><label>äº’å‹•æƒ…æ³ / å‚™è¨»ï¼ˆå¯è¼¸å…¥å¾ˆå¤šå…§å®¹ï¼‰</label><textarea id="p-note" placeholder="äº’å‹•å…§å®¹ã€éœ€æ±‚ã€è·Ÿé€²äº‹é …â€¦"></textarea></div>
      <div class="right" style="margin-top:6px">
        <button class="btn ok" id="p-add">æ–°å¢ / ç´¯åŠ äº’å‹•</button>
        <button class="btn" id="p-export">åŒ¯å‡º CSVï¼ˆäººå½™ç¸½ï¼‹äº’å‹•æ˜ç´°ï¼‰</button>
      </div>
      <table id="p-table"><thead><tr><th>#</th><th>ç¸£å¸‚</th><th>å§“å</th><th>æ—ç¾¤</th><th>æœ€è¿‘äº’å‹•æ—¥</th><th>æ¬¡æ•¸</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </section>

    <dialog id="dlg">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)">
        <div id="dlg-title">äº’å‹•è©³æƒ…</div>
        <button class="btn secondary" id="dlg-close">é—œé–‰</button>
      </div>
      <div style="padding:12px 14px" id="dlg-body"></div>
    </dialog>

    <div class="footer">è³‡æ–™åƒ…å­˜æ”¾æ–¼ä½ çš„è£ç½®ï¼ˆLocalStorageï¼‰ã€‚</div>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmt = d => d ? new Date(d).toISOString().slice(0,10) : "";
  const today = () => fmt(new Date());

  // Tabs
  $$(".tab").forEach(t=>t.addEventListener("click",()=>{
    $$(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const id=t.dataset.tab;
    ["u1","u2","u3","u4"].forEach(s=>$("#"+s).hidden=(s!==id));
  }));

  // Cities
  const CITIES = ["åŸºéš†å¸‚","è‡ºåŒ—å¸‚","æ–°åŒ—å¸‚","æ¡ƒåœ’å¸‚","æ–°ç«¹å¸‚","æ–°ç«¹ç¸£","è‹—æ —ç¸£","è‡ºä¸­å¸‚","å½°åŒ–ç¸£","å—æŠ•ç¸£","é›²æ—ç¸£","å˜‰ç¾©å¸‚","å˜‰ç¾©ç¸£","è‡ºå—å¸‚","é«˜é›„å¸‚","å±æ±ç¸£","å®œè˜­ç¸£","èŠ±è“®ç¸£","è‡ºæ±ç¸£","æ¾æ¹–ç¸£","é‡‘é–€ç¸£","é€£æ±Ÿç¸£"];
  function fillCities(sel){ sel.innerHTML = CITIES.map(c=>`<option value="${c}">${c}</option>`).join(""); }

  // Storage
  const KEY = "ifnt_integrated_data_v6_1";
  let DB = JSON.parse(localStorage.getItem(KEY) || JSON.stringify({
    recruit:[], bv:[], ibv:[], people:[], memories:{ customers:[], who:[], names:[], groups:[] },
    celebrated:{} // è¨˜éŒ„é”æ¨™æ˜¯å¦å·²æ…¶ç¥
  }));
  function persist(){ localStorage.setItem(KEY, JSON.stringify(DB)); }

  // Achievements
  function showBadge(anchorEl, text){
    if(!anchorEl) return;
    let b = anchorEl.querySelector('.achieve-badge');
    if(!b){
      b = document.createElement('span');
      b.className = 'achieve-badge';
      b.textContent = text || 'âœ… å·²é”æ¨™';
      anchorEl.appendChild(b);
    }else{
      b.textContent = text || 'âœ… å·²é”æ¨™';
    }
  }
  function celebrateOnce(key, anchorEl, text){
    const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if(DB.celebrated[key] || reduceMotion){
      showBadge(anchorEl, text);
      return;
    }
    DB.celebrated[key]=true; persist();
    const layer=document.createElement('div'); layer.className='confetti'; document.body.appendChild(layer);
    const colors=['#22c55e','#60a5fa','#f59e0b','#ef4444','#a78bfa','#f472b6'];
    const rect=anchorEl.getBoundingClientRect(); const originX=rect.left+rect.width/2; const originY=rect.top+window.scrollY+10;
    for(let i=0;i<140;i++){
      const el=document.createElement('i');
      el.style.background=colors[i%colors.length];
      el.style.left=originX+'px'; el.style.top=originY+'px';
      el.style.setProperty('--tx',(Math.random()*240-120)+'px');
      layer.appendChild(el);
    }
    setTimeout(()=>layer.remove(),1600);
    showBadge(anchorEl, text);
  }
  function resetCelebrateFlags(){ DB.celebrated={}; persist(); $$('.achieve-badge').forEach(b=>b.remove()); }

  // Section 1 Recruit
  $("#r-date").value = today();
  function renderRecruit(){
    $("#r-sum").textContent = DB.recruit.length;
    const tb=$("#r-table tbody"); tb.innerHTML="";
    DB.recruit.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${r.date}</td><td>${r.name}</td><td class="right"><button class="btn warn" data-i="${i}" data-act="r-del">åˆªé™¤</button></td>`;
      tb.appendChild(tr);
    });
    if(DB.recruit.length>=1) celebrateOnce('recruit', $('#recruitHeader'), 'ğŸ‰ å·²é”æˆ 1 äºº');
  }
  $("#r-add").onclick=()=>{
    const name=$("#r-name").value.trim(); const date=$("#r-date").value || today();
    if(!name){ alert("è«‹è¼¸å…¥å§“å"); return; }
    DB.recruit.push({date,name}); persist(); $("#r-name").value=""; renderRecruit();
  };
  $("#r-table").addEventListener("click",e=>{
    if(e.target.dataset.act==="r-del"){ DB.recruit.splice(+e.target.dataset.i,1); persist(); renderRecruit(); }
  });

  // Section 2 BV
  $("#b-date").value = today();
  function fillMemories(){
    $("#b-customers").innerHTML = DB.memories.customers.map(n=>`<option value="${n}">`).join("");
    $("#i-who-list").innerHTML = DB.memories.who.map(n=>`<option value="${n}">`).join("");
    $("#p-name-list").innerHTML = DB.memories.names.map(n=>`<option value="${n}">`).join("");
    $("#p-group-list").innerHTML = DB.memories.groups.map(n=>`<option value="${n}">`).join("");
  }
  function upsertMem(list,val){ if(!val) return; if(!list.includes(val)) list.push(val); }
  function renderBV(){
    const sum = DB.bv.reduce((a,b)=>a+(+b.bv||0),0);
    $("#b-sum").textContent = sum.toFixed(0);
    $("#b-left").textContent = Math.max(0,1500-sum).toFixed(0);
    const tb=$("#b-table tbody"); tb.innerHTML="";
    DB.bv.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${r.date}</td><td>${r.customer||""}</td><td>${r.item||""}</td><td>${r.bv}</td><td class="right"><button class="btn warn" data-i="${i}" data-act="b-del">åˆªé™¤</button></td>`;
      tb.appendChild(tr);
    });
    if(sum>=1500) celebrateOnce('bv', $('#bvHeader'), 'ğŸ‰ å·²é”æˆ 1500 BV');
  }
  $("#b-add").onclick=()=>{
    const date=$("#b-date").value||today(), customer=$("#b-customer").value.trim(), item=$("#b-item").value.trim(), bv=+$("#b-bv").value||0;
    if(!customer || !bv){ alert("è«‹è¼¸å…¥é¡§å®¢èˆ‡ BV"); return; }
    DB.bv.push({date,customer,item,bv}); upsertMem(DB.memories.customers,customer); persist(); fillMemories(); renderBV();
    $("#b-item").value=""; $("#b-bv").value="";
  };
  $("#b-table").addEventListener("click",e=>{
    if(e.target.dataset.act==="b-del"){ DB.bv.splice(+e.target.dataset.i,1); persist(); renderBV(); }
  });

  // Section 3 IBV
  $("#i-date").value = today();
  function renderIBV(){
    const sum = DB.ibv.reduce((a,b)=>a+(+b.ibv||0),0);
    $("#i-sum").textContent = sum.toFixed(0);
    $("#i-left").textContent = Math.max(0,300-sum).toFixed(0);
    const tb=$("#i-table tbody"); tb.innerHTML="";
    DB.ibv.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${r.date}</td><td>${r.who||""}</td><td>${r.item||""}</td><td>${r.ibv}</td><td class="right"><button class="btn warn" data-i="${i}" data-act="i-del">åˆªé™¤</button></td>`;
      tb.appendChild(tr);
    });
    if(sum>=300) celebrateOnce('ibv', $('#ibvHeader'), 'ğŸ‰ å·²é”æˆ 300 IBV');
  }
  $("#i-add").onclick=()=>{
    const date=$("#i-date").value||today(), who=$("#i-who").value.trim(), item=$("#i-item").value.trim(), ibv=+$("#i-ibv").value||0;
    if(!who || !ibv){ alert("è«‹è¼¸å…¥å°è±¡èˆ‡ IBV"); return; }
    DB.ibv.push({date,who,item,ibv}); upsertMem(DB.memories.who,who); persist(); fillMemories(); renderIBV();
    $("#i-item").value=""; $("#i-ibv").value="";
  };
  $("#i-table").addEventListener("click",e=>{
    if(e.target.dataset.act==="i-del"){ DB.ibv.splice(+e.target.dataset.i,1); persist(); renderIBV(); }
  });

  // Section 4 People
  fillCities($("#p-city"));
  $("#p-date").value = today();
  function findPerson(name){ return DB.people.find(p => p.name === name); }
  function renderPeople(){
    const tb=$("#p-table tbody"); tb.innerHTML="";
    DB.people.sort((a,b)=> (b.lastDate||"").localeCompare(a.lastDate||""));
    DB.people.forEach((p,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${p.city||""}</td><td>${p.name||""}</td><td>${p.group||""}</td>
        <td>${p.lastDate||""}</td><td>${(p.interactions||[]).length}</td>
        <td class="right">
          <button class="btn" data-i="${i}" data-act="p-view">æŸ¥çœ‹</button>
          <button class="btn danger" data-i="${i}" data-act="p-del">åˆªé™¤</button>
        </td>`;
      tb.appendChild(tr);
    });
  }
  $("#p-name").addEventListener("change",()=>{
    const nm=$("#p-name").value.trim(); const p=findPerson(nm);
    if(p){ $("#p-city").value=p.city||$("#p-city").value; $("#p-group").value=p.group||""; }
  });
  $("#p-add").onclick=()=>{
    const city=$("#p-city").value, name=$("#p-name").value.trim(), group=$("#p-group").value.trim();
    const date=$("#p-date").value||today(), note=$("#p-note").value.trim();
    if(!name){ alert("è«‹è¼¸å…¥å§“å"); return; }
    let p=findPerson(name);
    if(!p){ p={city,name,group,interactions:[]}; DB.people.push(p); }
    p.city=city; if(group) p.group=group;
    p.interactions.push({date, note}); p.lastDate=date;
    if(!DB.memories.names.includes(name)) DB.memories.names.push(name);
    if(group && !DB.memories.groups.includes(group)) DB.memories.groups.push(group);
    persist(); fillMemories(); renderPeople();
    // v6.1: æ¸…ç©ºå§“å/æ—ç¾¤ï¼ˆä¿ç•™ç¸£å¸‚èˆ‡æ—¥æœŸï¼‰ï¼Œèšç„¦å§“å
    $("#p-name").value=""; $("#p-group").value="";
    $("#p-name").focus();
  };
  $("#p-table").addEventListener("click",e=>{
    const i=+e.target.dataset.i; const act=e.target.dataset.act;
    if(act==="p-del"){ if(confirm("ç¢ºå®šåˆªé™¤æ­¤äººèˆ‡æ‰€æœ‰äº’å‹•ï¼Ÿ")){ DB.people.splice(i,1); persist(); renderPeople(); } return;}
    if(act==="p-view"){ openPerson(i); }
  });
  function openPerson(i){
    const p=DB.people[i]; $("#dlg-title").textContent = `${p.name}ï¼ˆ${p.city||"-"}ï½œ${p.group||"-"}ï¼‰`;
    const body = [`<div class="row"><button class="btn" data-i="${i}" id="ex-person">åŒ¯å‡ºæ­¤äºº CSV</button></div>`,
      `<table style="width:100%;margin-top:10px"><thead><tr><th>#</th><th>æ—¥æœŸ</th><th>å…§å®¹</th><th>æ“ä½œ</th></tr></thead><tbody>`,
      ...p.interactions.map((it,idx)=>`<tr><td>${idx+1}</td><td>${it.date}</td><td>${(it.note||"").replace(/</g,"&lt;")}</td>
        <td class="right"><button class="btn warn" data-i="${i}" data-j="${idx}" data-act="p-del-inter">åˆªé™¤</button></td></tr>`),
      `</tbody></table>`].join("");
    $("#dlg-body").innerHTML = body;
    $("#dlg").showModal();
    $("#ex-person").onclick=()=> exportPersonCSV(p);
    $("#dlg-body").onclick = (ev)=>{
      const t=ev.target; if(t.dataset.act==="p-del-inter"){ const j=+t.dataset.j; DB.people[i].interactions.splice(j,1); persist(); openPerson(i); renderPeople(); }
    }
  }
  $("#dlg-close").onclick = ()=> $("#dlg").close();

  function toCSV(rows){
    return rows.map(r => r.map(v => {
      v = (v==null?"":String(v));
      if(/[",
]/.test(v)) v='"'+v.replace(/"/g,'""')+'"';
      return v;
    }).join(",")).join("
");
  }
  function download(name, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }
  function exportAllCSV(){
    const sumRows = [["ç¸£å¸‚","å§“å","æ—ç¾¤","æœ€è¿‘äº’å‹•æ—¥","äº’å‹•æ¬¡æ•¸"]];
    DB.people.forEach(p=> sumRows.push([p.city,p.name,p.group,p.lastDate,(p.interactions||[]).length]));
    const detRows = [["ç¸£å¸‚","å§“å","æ—ç¾¤","æ—¥æœŸ","å…§å®¹"]];
    DB.people.forEach(p=> (p.interactions||[]).forEach(it=> detRows.push([p.city,p.name,p.group,it.date,it.note])) );
    download(`IFNT-äººå½™ç¸½-${today()}.csv`, toCSV(sumRows));
    download(`IFNT-äº’å‹•æ˜ç´°-${today()}.csv`, toCSV(detRows));
  }
  function exportPersonCSV(p){
    const rows=[["å§“å",p.name],["ç¸£å¸‚",p.city],["æ—ç¾¤",p.group],[],["æ—¥æœŸ","å…§å®¹"]];
    (p.interactions||[]).forEach(it=> rows.push([it.date,it.note]));
    download(`IFNT-${p.name}-${today()}.csv`, toCSV(rows));
  }
  $("#p-export").onclick = exportAllCSV;

  // Init
  fillCities($("#p-city"));
  $("#p-date").value = today(); $("#b-date").value = today(); $("#i-date").value = today(); $("#r-date").value = today();
  function fillMemories(){ /* already defined above but re-run at boot */ }
  // Restore memories arrays if missing
  if(!DB.memories) DB.memories={customers:[],who:[],names:[],groups:[]};
  // Render sequences
  (function boot(){
    // Rebind proper fillMemories now (overwrite placeholder)
    function _fill(){
      $("#b-customers").innerHTML = DB.memories.customers.map(n=>`<option value="${n}">`).join("");
      $("#i-who-list").innerHTML = DB.memories.who.map(n=>`<option value="${n}">`).join("");
      $("#p-name-list").innerHTML = DB.memories.names.map(n=>`<option value="${n}">`).join("");
      $("#p-group-list").innerHTML = DB.memories.groups.map(n=>`<option value="${n}">`).join("");
    }
    fillMemories = _fill; // reassign
    fillMemories();
    renderRecruit(); renderBV(); renderIBV(); renderPeople();
  })();
</script>
</body>
</html>
