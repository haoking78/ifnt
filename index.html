<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>IFNT Â· ç„¡é™ç¿»è½‰äººç”Ÿï½œæ¯å­£ UFO ä¸‰é …ï¼ˆåŸå¸‚ä¸‹æ‹‰ï¼‹å§“å/æ—ç¾¤è¨˜æ†¶æ•´åˆç‰ˆï¼‰</title>
<!-- ä¸å¿«å–ï¼šæ¯æ¬¡é‡æ–°æ•´ç†éƒ½æŠ“æ–°æª” -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a2540">
<style>
:root{
  --bg:#071a2c; --card:#0b2744; --muted:#98b2c6; --text:#e9f4ff; --line:rgba(255,255,255,.12);
  --accent:#42b6ff; --accent2:#8ad4ff; --ok:#20d88a; --warn:#ffd166; --danger:#ff6b6b;
  --radius:14px; --gap:14px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(800px 500px at 90% -10%, rgba(66,182,255,.18), transparent 60%),
    radial-gradient(600px 400px at -10% 110%, rgba(138,212,255,.12), transparent 55%),
    var(--bg);
  color:var(--text);
  font-family: Inter, ui-sans-serif, -apple-system, "Noto Sans TC", "Microsoft JhengHei", "PingFang TC", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
}
header{position:sticky;top:0;z-index:20;padding:10px 12px;background:linear-gradient(180deg, rgba(10,37,64,.96), rgba(10,37,64,.7));backdrop-filter: blur(8px); border-bottom:1px solid var(--line)}
.hbar{max-width:1100px;margin:auto;display:flex;gap:10px;align-items:center}
.logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:grid;place-items:center;color:#002037;font-weight:900;font-size:12px;letter-spacing:1px}
.ttl{font-weight:800;letter-spacing:.3px;font-size:16px}
.toolbar{margin-left:auto;display:none;gap:8px;flex-wrap:wrap}
.btn{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
.btn:hover{border-color:rgba(255,255,255,.25)}
.m-actions{margin-left:auto}
.iconbtn{width:36px;height:36px;border-radius:10px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);display:grid;place-items:center;font-size:20px}
.sheet{position:fixed;inset:auto 0 0 0;background:rgba(7,26,44,.7);backdrop-filter:blur(4px);display:none}
.sheet.open{display:block}
.sheet .box{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border-top:1px solid var(--line);padding:12px;display:grid;gap:10px}
.sheet .box .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
main{max-width:900px;margin:12px auto;padding:0 12px;display:grid;gap:var(--gap)}
.card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
h2{margin:0 0 8px; color:#cfe9ff; letter-spacing:.2px; font-size:16px}
.note{color:var(--muted); font-size:12px}
.grid{display:grid;grid-template-columns:1fr;gap:10px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select,textarea{background:#0e3154;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 12px;width:100%;font-size:15px}
textarea.textarea-big{min-height:120px; resize:vertical}
.pill{display:inline-block;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:13px}
.ok{color:var(--ok)} .loss{color:var(--danger)} .warn{color:var(--warn)}
.kpis{display:grid;grid-template-columns:1fr;gap:10px}
.kpi{background:#0b2b4b;border:1px solid var(--line);border-radius:12px;padding:12px}
.kpi h3{margin:0 0 6px; font-size:12px; color:#a5c6db}
.kpi .v{font-size:20px; font-weight:800}
.progress{height:12px;border-radius:999px;background:#0c2f52;border:1px solid var(--line);overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px 6px;text-align:center}
th{color:#aac7db}
.del{cursor:pointer;border:1px solid rgba(255,255,255,.18);border-radius:8px;padding:4px 10px;background:rgba(255,255,255,.06)}
.del:hover{background:rgba(255,0,0,.18)}
.footer{opacity:.7;text-align:center;padding:18px 0 24px;font-size:12px}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#cfe9ff}
.subtle{color:var(--muted);font-size:12px}
.accordion{background:#0b2b4b;border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:10px}
.timeline{list-style:none;margin:8px 0 0;padding:0}
.timeline li{border-left:2px solid rgba(255,255,255,.15);padding:6px 10px;margin-left:6px;margin-bottom:6px}
.timeline .date{color:#aac7db;font-size:12px;margin-right:8px}
@media (min-width:768px){
  .toolbar{display:flex}
  .m-actions{display:none}
  .grid.grid-3{grid-template-columns:repeat(3,1fr)}
  .kpis{grid-template-columns:repeat(4,1fr)}
}
</style>
</head>
<body>
<header>
  <div class="hbar">
    <div class="logo">IFNT</div>
    <div class="ttl">IFNT Â· ç„¡é™ç¿»è½‰äººç”Ÿï½œæ¯å­£ UFO ä¸‰é …</div>
    <div class="toolbar">
      <button class="btn" id="btnExportJSON">åŒ¯å‡º JSON</button>
      <label class="btn">åŒ¯å…¥ JSON<input type="file" id="impJSON" accept="application/json,.json" hidden></label>
      <button class="btn" id="btnClear">æ¸…ç©ºå…¨éƒ¨</button>
      <button class="btn" id="btnInstall">åŠ å…¥ä¸»ç•«é¢</button>
      <button class="btn" id="btnSettings">è¨­å®š</button>
    </div>
    <div class="m-actions">
      <button class="iconbtn" id="openSheet">â‹®</button>
    </div>
  </div>
</header>
<div class="sheet" id="sheet">
  <div class="box">
    <div class="row">
      <button class="btn" id="mExp">åŒ¯å‡º JSON</button>
      <label class="btn">åŒ¯å…¥ JSON<input type="file" id="mImp" accept="application/json,.json" hidden></label>
      <button class="btn" id="mClear">æ¸…ç©ºå…¨éƒ¨</button>
      <button class="btn" id="mInstall">åŠ å…¥ä¸»ç•«é¢</button>
      <button class="btn" id="mSettings">è¨­å®š</button>
    </div>
    <button class="btn" id="closeSheet">é—œé–‰</button>
  </div>
</div>
<main>
  <section class="card">
    <h2>å­£åº¦ç¸½è¦½ï¼ˆDashboardï¼‰</h2>
    <div class="kpis">
      <div class="kpi"><h3>è¦ªè‡ªæ‹›å‹Ÿï¼ˆç›®æ¨™ï¼š1äººï¼‰</h3><div class="v" id="k1">0 / 1 äºº</div><div class="progress"><i id="b1"></i></div></div>
      <div class="kpi"><h3>é›¶å”®ï¼‹è‡ªè³¼ï¼ˆç›®æ¨™ï¼š1500 BVï¼‰</h3><div class="v" id="k2">0 / 1500 BVï¼ˆå·® 1500ï¼‰</div><div class="progress"><i id="b2"></i></div></div>
      <div class="kpi"><h3>å®¶åº­è½‰ç§»æ¶ˆè²»ï¼ˆç›®æ¨™ï¼š300 IBVï¼‰</h3><div class="v" id="k3">0 / 300 IBVï¼ˆå·® 300ï¼‰</div><div class="progress"><i id="b3"></i></div></div>
      <div class="kpi"><h3>å­£åº¦è¨­å®š</h3><div class="v" id="qLabel">ï¼ˆæœªè¨­å®šï¼‰</div></div>
    </div>
  </section>
  <section class="card">
    <h2>â‘  è¦ªè‡ªæ‹›å‹Ÿ 1 äºº</h2>
    <div class="grid">
      <input id="rDate" type="date">
      <input id="rName" type="text" placeholder="æ‹›å‹Ÿå§“åï¼ˆå¿…å¡«ï¼‰">
      <button class="btn" id="rAdd">æ–°å¢æ‹›å‹Ÿ</button>
    </div>
    <div class="row" style="margin-top:6px">
      <span class="pill">ç´¯è¨ˆäººæ•¸ï¼š<span id="rCount">0</span>ï¼ç›®æ¨™ 1</span>
      <span class="pill" id="rStatus">æœªé”æ¨™</span>
      <div style="margin-left:auto"></div>
      <button class="btn" id="rExpCSV">åŒ¯å‡ºCSV</button>
    </div>
    <table>
      <thead><tr><th>#</th><th>æ—¥æœŸ</th><th>å§“å</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="rBody"></tbody>
    </table>
  </section>
  <section class="card">
    <h2>â‘¡ é›¶å”®ï¼‹è‡ªè³¼ 1500 BV</h2>
    <div class="grid">
      <input id="bDate" type="date">
      <input id="bName" type="text" placeholder="é¡§å®¢å§“åï¼ˆå¿…å¡«ï¼‰">
      <input id="bItem" type="text" placeholder="é›¶å”®å“é …ï¼ˆè‡ªè¡Œè¼¸å…¥ï¼‰">
      <input id="bAmt" type="number" placeholder="é›¶å”® BVï¼ˆå¿…å¡«ï¼‰">
      <button class="btn" id="bAdd">æ–°å¢ BV</button>
    </div>
    <div class="kpis" style="margin-top:8px">
      <div class="kpi"><h3>ç´¯è¨ˆ BV</h3><div class="v" id="bSumV">0</div><div class="progress"><i id="bBar"></i></div></div>
      <div class="kpi"><h3>è·é›¢ç›®æ¨™</h3><div class="v" id="bRemainV">1500</div></div>
      <div class="kpi"><h3>ç›®æ¨™</h3><div class="v" id="bGoalV">1500</div></div>
      <div class="kpi"><h3>ç‹€æ…‹</h3><div class="v" id="bStatus">æœªé”æ¨™</div></div>
    </div>
    <div class="row" style="margin-top:6px;justify-content:end">
      <button class="btn" id="bExpCSV">åŒ¯å‡ºCSV</button>
    </div>
    <table>
      <thead><tr><th>#</th><th>æ—¥æœŸ</th><th>é¡§å®¢å§“å</th><th>å“é …</th><th>BV</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="bBody"></tbody>
    </table>
  </section>
  <section class="card">
    <h2>â‘¢ å®¶åº­è½‰ç§»æ¶ˆè²» 300 IBV</h2>
    <div class="grid">
      <input id="iDate" type="date">
      <input id="iName" type="text" placeholder="é¡§å®¢å§“åæˆ–è‡ªå·±ï¼ˆå¿…å¡«ï¼‰">
      <input id="iItem" type="text" placeholder="æ¶ˆè²»å“é …ï¼ˆè‡ªè¡Œè¼¸å…¥ï¼‰">
      <input id="iAmt" type="number" placeholder="IBVï¼ˆå¿…å¡«ï¼‰">
      <button class="btn" id="iAdd">æ–°å¢ IBV</button>
    </div>
    <div class="kpis" style="margin-top:8px">
      <div class="kpi"><h3>ç´¯è¨ˆ IBV</h3><div class="v" id="iSumV">0</div><div class="progress"><i id="iBar"></i></div></div>
      <div class="kpi"><h3>è·é›¢ç›®æ¨™</h3><div class="v" id="iRemainV">300</div></div>
      <div class="kpi"><h3>ç›®æ¨™</h3><div class="v" id="iGoalV">300</div></div>
      <div class="kpi"><h3>ç‹€æ…‹</h3><div class="v" id="iStatus">æœªé”æ¨™</div></div>
    </div>
    <div class="row" style="margin-top:6px;justify-content:end">
      <button class="btn" id="iExpCSV">åŒ¯å‡ºCSV</button>
    </div>
    <table>
      <thead><tr><th>#</th><th>æ—¥æœŸ</th><th>å§“å</th><th>å“é …</th><th>IBV</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="iBody"></tbody>
    </table>
  </section>

  <section class="card" id="mod-312">
    <h2>â‘£ 312 äº’å‹•åå–®</h2>
    <div class="grid">
      <select id="cCity">
        <option value="" selected>é¸æ“‡å±…ä½ç¸£å¸‚ï¼ˆå¿…é¸ï¼‰</option>
        <option>å°åŒ—å¸‚</option><option>æ–°åŒ—å¸‚</option><option>æ¡ƒåœ’å¸‚</option><option>å°ä¸­å¸‚</option><option>å°å—å¸‚</option><option>é«˜é›„å¸‚</option>
        <option>åŸºéš†å¸‚</option><option>æ–°ç«¹å¸‚</option><option>å˜‰ç¾©å¸‚</option>
        <option>æ–°ç«¹ç¸£</option><option>è‹—æ —ç¸£</option><option>å½°åŒ–ç¸£</option><option>å—æŠ•ç¸£</option><option>é›²æ—ç¸£</option><option>å˜‰ç¾©ç¸£</option>
        <option>å±æ±ç¸£</option><option>å®œè˜­ç¸£</option><option>èŠ±è“®ç¸£</option><option>å°æ±ç¸£</option>
        <option>æ¾æ¹–ç¸£</option><option>é‡‘é–€ç¸£</option><option>é€£æ±Ÿç¸£</option>
      </select>

      <input id="cName" type="text" list="nameList" placeholder="å§“åï¼ˆå¯é¸æ¸…å–®æˆ–è‡ªè¡Œè¼¸å…¥ï¼Œå¿…å¡«ï¼‰">
      <datalist id="nameList"></datalist>

      <input id="cGroup" type="text" list="groupList" placeholder="æ—ç¾¤ï¼ˆå¯é¸æ¸…å–®æˆ–è‡ªè¡Œè¼¸å…¥ï¼Œå¿…å¡«ï¼‰">
      <datalist id="groupList"></datalist>

      <input id="cDate" type="date">
      <textarea id="cNote" class="textarea-big" placeholder="äº’å‹•æƒ…æ³ / å‚™è¨»ï¼ˆå¯è¼¸å…¥å¾ˆå¤šå…§å®¹ï¼‰"></textarea>
      <button class="btn" id="cAdd">æ–°å¢ / ç´¯åŠ äº’å‹•</button>
    </div>
    <div class="kpis" style="margin-top:8px">
      <div class="kpi"><h3>äººå“¡æ•¸</h3><div class="v" id="cPeople">0</div></div>
      <div class="kpi"><h3>äº’å‹•ç¸½æ¬¡æ•¸</h3><div class="v" id="cLogs">0</div></div>
      <div class="kpi"><h3>æœ€è¿‘äº’å‹•æ—¥</h3><div class="v" id="cLast">â€”</div></div>
      <div class="kpi"><h3>å·¥å…·</h3><div class="v">
        <button class="btn" id="cExpPeople">åŒ¯å‡ºäººå“¡CSV</button>
        <button class="btn" id="cExpLogs">åŒ¯å‡ºäº’å‹•CSV</button>
      </div></div>
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th><th>ç¸£å¸‚</th><th>å§“å</th><th>æ—ç¾¤</th><th>æœ€è¿‘äº’å‹•æ—¥</th><th>æ¬¡æ•¸</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="cBody"></tbody>
    </table>
    <div id="cDetail" class="accordion" hidden>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="badge" id="dCity"></span>
        <span class="badge" id="dName"></span>
        <span class="badge" id="dGroup"></span>
        <span class="subtle" id="dCount"></span>
        <div style="margin-left:auto"></div>
        <button class="btn" id="dClose">æ”¶èµ·è©³æƒ…</button>
      </div>
      <div class="grid" style="margin-top:10px">
        <input id="dDate" type="date">
        <textarea id="dNote" class="textarea-big" placeholder="æ–°å¢é€™ä½çš„äº’å‹•ç´€éŒ„â€¦"></textarea>
        <button class="btn" id="dAdd">æ–°å¢é€™ä½çš„äº’å‹•ç´€éŒ„</button>
      </div>
      <ul class="timeline" id="dTimeline"></ul>
    </div>
  </section>

  <section class="card" id="settings" hidden>
    <h2>è¨­å®š</h2>
    <div class="grid">
      <div><div class="note">å­£åº¦é–‹å§‹</div><input id="qStart" type="date"></div>
      <div><div class="note">å­£åº¦çµæŸ</div><input id="qEnd" type="date"></div>
      <div><div class="note">é›¶å”®ï¼‹è‡ªè³¼ ç›®æ¨™ BV</div><input id="goalBV" type="number" placeholder="é è¨­ 1500"></div>
      <div><div class="note">å®¶åº­è½‰ç§» ç›®æ¨™ IBV</div><input id="goalIBV" type="number" placeholder="é è¨­ 300"></div>
    </div>
    <div class="row" style="margin-top:8px;justify-content:end">
      <button class="btn" id="apply">å„²å­˜ä¸¦å¥—ç”¨</button>
      <button class="btn" id="collapse">æ”¶èµ·</button>
    </div>
    <div class="note" style="margin-top:6px">æ‰€æœ‰è³‡æ–™åƒ…å„²å­˜åœ¨æ­¤è£ç½®ï¼ˆlocalStorageï¼‰ã€‚</div>
  </section>
  <div class="footer">Â© IFNT Â· ç„¡é™ç¿»è½‰äººç”Ÿ Â· PWA Â· è¡Œå‹•ç‰ˆæœ€ä½³åŒ–</div>
</main>
<script>
const $ = s=>document.querySelector(s);
const nf = new Intl.NumberFormat('zh-Hant',{maximumFractionDigits:0});
const todayStr = () => new Date().toISOString().slice(0,10);
function get(k,d){ try{const v=localStorage.getItem(k); return v? JSON.parse(v): d;}catch(e){return d;} }
function set(k,v){ try{localStorage.setItem(k, JSON.stringify(v));}catch(e){} }

const st = {
  qStart: get('qStart',''),
  qEnd: get('qEnd',''),
  goalBV: get('goalBV',1500),
  goalIBV: get('goalIBV',300),
  recruits: get('recruits',[]),
  bvs: get('bvs',[]),
  ibvs: get('ibvs',[]),
  contacts: get('contacts', []),
  nameOpts: get('nameOpts', []),
  groupOpts: get('groupOpts', [])
};

['rDate','bDate','iDate','cDate','dDate'].forEach(id=>{ const el=$('#'+id); if(el) el.value=todayStr(); });

function refreshDatalists(){
  const nameList = $('#nameList'); const groupList = $('#groupList');
  if(nameList) nameList.innerHTML = st.nameOpts.map(n=> `<option value="${n}"></option>`).join('');
  if(groupList) groupList.innerHTML = st.groupOpts.map(g=> `<option value="${g}"></option>`).join('');
}
function maybeAddToOptions(name, group){
  if(name){
    if(!st.nameOpts.includes(name)){ st.nameOpts.unshift(name); }
    if(st.nameOpts.length>200) st.nameOpts.pop();
    set('nameOpts', st.nameOpts);
  }
  if(group){
    if(!st.groupOpts.includes(group)){ st.groupOpts.unshift(group); }
    if(st.groupOpts.length>200) st.groupOpts.pop();
    set('groupOpts', st.groupOpts);
  }
  refreshDatalists();
}

function openSettings(){ $('#settings').hidden=false; }
function closeSettings(){ $('#settings').hidden=true; }
$('#btnSettings').addEventListener('click', openSettings);
const mSettings = $('#mSettings'); if(mSettings){ mSettings.addEventListener('click', ()=>{closeSheet(); openSettings();}); }
$('#collapse').addEventListener('click', closeSettings);
$('#apply').addEventListener('click', ()=>{
  st.qStart = $('#qStart').value || st.qStart;
  st.qEnd = $('#qEnd').value || st.qEnd;
  st.goalBV = Number($('#goalBV').value || st.goalBV || 1500);
  st.goalIBV = Number($('#goalIBV').value || st.goalIBV || 300);
  set('qStart', st.qStart); set('qEnd', st.qEnd);
  set('goalBV', st.goalBV); set('goalIBV', st.goalIBV);
  renderAll(); alert('è¨­å®šå·²å„²å­˜');
});

function addRecruit(){
  const d=$('#rDate').value, n=($('#rName').value||'').trim();
  if(!n){ alert('è«‹è¼¸å…¥æ‹›å‹Ÿå§“å'); return; }
  st.recruits.push({date:d,name:n}); set('recruits', st.recruits);
  $('#rName').value=''; renderRecruits(); renderDashboard();
}
function delRecruit(i){ st.recruits.splice(i,1); set('recruits', st.recruits); renderRecruits(); renderDashboard(); }

function addBV(){
  const d=$('#bDate').value, n=($('#bName').value||'').trim(), it=($('#bItem').value||'').trim(), v=Number($('#bAmt').value||0);
  if(!n || !v){ alert('è«‹è¼¸å…¥é¡§å®¢å§“åèˆ‡ BV'); return; }
  st.bvs.push({date:d,name:n,item:it,bv:v}); set('bvs', st.bvs);
  $('#bName').value=''; $('#bItem').value=''; $('#bAmt').value=''; renderBV(); renderDashboard();
}
function delBV(i){ st.bvs.splice(i,1); set('bvs', st.bvs); renderBV(); renderDashboard(); }

function addIBV(){
  const d=$('#iDate').value, n=($('#iName').value||'').trim(), it=($('#iItem').value||'').trim(), v=Number($('#iAmt').value||0);
  if(!n || !v){ alert('è«‹è¼¸å…¥å§“åèˆ‡ IBV'); return; }
  st.ibvs.push({date:d,name:n,item:it,ibv:v}); set('ibvs', st.ibvs);
  $('#iName').value=''; $('#iItem').value=''; $('#iAmt').value=''; renderIBV(); renderDashboard();
}
function delIBV(i){ st.ibvs.splice(i,1); set('ibvs', st.ibvs); renderIBV(); renderDashboard(); }

$('#rAdd').addEventListener('click', addRecruit);
$('#bAdd').addEventListener('click', addBV);
$('#iAdd').addEventListener('click', addIBV);

function csvEscape(s){ s=String(s); return s.includes(',')? `"${s.replace(/"/g,'""')}"`: s; }
function exportCSV(arr, headers, name){
  const lines=[headers.join(',')];
  arr.forEach((row,i)=>{
    const map={ '#':'#','æ—¥æœŸ':'date','å§“å':'name','é¡§å®¢å§“å':'name','å“é …':'item','BV':'bv','IBV':'ibv' };
    const vals=headers.map(h=> h==='#' ? i+1 : csvEscape(row[map[h]||h] ?? ''));
    lines.push(vals.join(','));
  });
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click();
}
$('#rExpCSV').addEventListener('click', ()=> exportCSV(st.recruits, ['#','æ—¥æœŸ','å§“å'], 'recruits.csv'));
$('#bExpCSV').addEventListener('click', ()=> exportCSV(st.bvs, ['#','æ—¥æœŸ','é¡§å®¢å§“å','å“é …','BV'], 'bv.csv'));
$('#iExpCSV').addEventListener('click', ()=> exportCSV(st.ibvs, ['#','æ—¥æœŸ','å§“å','å“é …','IBV'], 'ibv.csv'));

function exportJSON(){ const blob=new Blob([JSON.stringify(st,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ufo_backup.json'; a.click(); }
$('#btnExportJSON').addEventListener('click', exportJSON);
const mExp = $('#mExp'); if(mExp){ mExp.addEventListener('click', ()=>{ exportJSON(); closeSheet(); }); }

async function importJSON(file){
  const text=await file.text();
  try{
    const data=JSON.parse(text);
    if(typeof data==='object'){
      Object.assign(st,data);
      set('qStart', st.qStart); set('qEnd', st.qEnd); set('goalBV', st.goalBV); set('goalIBV', st.goalIBV);
      set('recruits', st.recruits); set('bvs', st.bvs); set('ibvs', st.ibvs); set('contacts', st.contacts||[]);
      set('nameOpts', st.nameOpts||[]); set('groupOpts', st.groupOpts||[]);
      refreshDatalists();
      renderAll();
    }else alert('JSON æ ¼å¼ä¸æ­£ç¢º');
  }catch{ alert('JSON è§£æå¤±æ•—'); }
}
$('#impJSON').addEventListener('change', e=>{ if(e.target.files[0]) importJSON(e.target.files[0]); e.target.value=''; });
const mImp = $('#mImp'); if(mImp){ mImp.addEventListener('change', e=>{ if(e.target.files[0]) importJSON(e.target.files[0]); e.target.value=''; closeSheet(); }); }

function clearAll(){
  if(!confirm('ç¢ºå®šè¦æ¸…ç©ºå…¨éƒ¨è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•é‚„åŸ')) return;
  st.recruits=[]; st.bvs=[]; st.ibvs=[]; st.contacts=[]; st.nameOpts=[]; st.groupOpts=[];
  set('recruits', st.recruits); set('bvs', st.bvs); set('ibvs', st.ibvs); set('contacts', st.contacts);
  set('nameOpts', st.nameOpts); set('groupOpts', st.groupOpts);
  refreshDatalists();
  renderAll();
}
$('#btnClear').addEventListener('click', clearAll);
const mClear = $('#mClear'); if(mClear){ mClear.addEventListener('click', ()=>{ clearAll(); closeSheet(); }); }

let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt=e; });
function doInstall(){
  if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; }
  else alert('è‹¥è¦åŠ å…¥ä¸»ç•«é¢ï¼šè«‹ç”¨ç€è¦½å™¨ã€Œåˆ†äº«ã€â†’ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚');
}
$('#btnInstall').addEventListener('click', doInstall);
const mInstall = $('#mInstall'); if(mInstall){ mInstall.addEventListener('click', ()=>{ doInstall(); closeSheet(); }); }

const sheet=$('#sheet');
function openSheet(){ sheet.classList.add('open'); }
function closeSheet(){ sheet.classList.remove('open'); }
$('#openSheet').addEventListener('click', openSheet);
$('#closeSheet').addEventListener('click', closeSheet);
sheet.addEventListener('click', e=>{ if(e.target===sheet) closeSheet(); });

function withinQuarter(dateStr){
  if(!st.qStart || !st.qEnd) return true;
  return dateStr >= st.qStart && dateStr <= st.qEnd;
}
function renderDashboard(){
  const rCnt=st.recruits.filter(x=>withinQuarter(x.date)).length;
  $('#k1').textContent=`${rCnt} / 1 äºº`; $('#b1').style.width=Math.min(100,Math.round(rCnt*100))+'%';
  $('#rCount').textContent=rCnt; $('#rStatus').textContent=rCnt>=1?'å·²é”æ¨™':'æœªé”æ¨™';
  $('#rStatus').className='pill '+(rCnt>=1?'ok':'warn');

  const bvSum=st.bvs.filter(x=>withinQuarter(x.date)).reduce((s,x)=>s+(+x.bv||0),0);
  const bGoal=+st.goalBV||1500, bRemain=Math.max(0,bGoal-bvSum);
  $('#k2').textContent=`${nf.format(bvSum)} / ${bGoal} BVï¼ˆå·® ${nf.format(bRemain)}ï¼‰`; $('#b2').style.width=Math.min(100,Math.round(bvSum/bGoal*100))+'%';
  $('#bSumV').textContent=nf.format(bvSum); $('#bRemainV').textContent=nf.format(bRemain); $('#bGoalV').textContent=nf.format(bGoal);
  $('#bBar').style.width=Math.min(100,Math.round(bvSum/bGoal*100))+'%'; $('#bStatus').textContent=bvSum>=bGoal?'å·²é”æ¨™':'æœªé”æ¨™'; $('#bStatus').className='v '+(bvSum>=bGoal?'ok':'warn');

  const ibvSum=st.ibvs.filter(x=>withinQuarter(x.date)).reduce((s,x)=>s+(+x.ibv||0),0);
  const iGoal=+st.goalIBV||300, iRemain=Math.max(0,iGoal-ibvSum);
  $('#k3').textContent=`${nf.format(ibvSum)} / ${iGoal} IBVï¼ˆå·® ${nf.format(iRemain)}ï¼‰`; $('#b3').style.width=Math.min(100,Math.round(ibvSum/iGoal*100))+'%';
  $('#iSumV').textContent=nf.format(ibvSum); $('#iRemainV').textContent=nf.format(iRemain); $('#iGoalV').textContent=nf.format(iGoal);
  $('#iBar').style.width=Math.min(100,Math.round(ibvSum/iGoal*100))+'%'; $('#iStatus').textContent=iGoal<=ibvSum?'å·²é”æ¨™':'æœªé”æ¨™'; $('#iStatus').className='v '+(ibvSum>=iGoal?'ok':'warn');

  $('#qLabel').textContent=(st.qStart&&st.qEnd)? `${st.qStart} ï½ ${st.qEnd}` : 'ï¼ˆæœªè¨­å®šï¼‰';
}
function renderRecruits(){
  const body=$('#rBody'); body.innerHTML='';
  st.recruits.map((x,i)=>({...x,_i:i})).filter(x=>withinQuarter(x.date)).sort((a,b)=>a.date.localeCompare(b.date)).forEach((x,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx+1}</td><td>${x.date}</td><td>${x.name}</td><td><button class="del" onclick="delRecruit(${x._i})">ğŸ—‘ åˆªé™¤</button></td>`;
    body.appendChild(tr);
  });
}
function renderBV(){
  const body=$('#bBody'); body.innerHTML='';
  st.bvs.map((x,i)=>({...x,_i:i})).filter(x=>withinQuarter(x.date)).sort((a,b)=>a.date.localeCompare(b.date)).forEach((x,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx+1}</td><td>${x.date}</td><td>${x.name}</td><td>${x.item||''}</td><td>${nf.format(x.bv)}</td><td><button class="del" onclick="delBV(${x._i})">ğŸ—‘ åˆªé™¤</button></td>`;
    body.appendChild(tr);
  });
}
function renderIBV(){
  const body=$('#iBody'); body.innerHTML='';
  st.ibvs.map((x,i)=>({...x,_i:i})).filter(x=>withinQuarter(x.date)).sort((a,b)=>a.date.localeCompare(b.date)).forEach((x,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx+1}</td><td>${x.date}</td><td>${x.name}</td><td>${x.item||''}</td><td>${nf.format(x.ibv)}</td><td><button class="del" onclick="delIBV(${x._i})">ğŸ—‘ åˆªé™¤</button></td>`;
    body.appendChild(tr);
  });
}

function openContact(id){
  const c = st.contacts.find(x=> x.id===id);
  if(!c) return;
  $('#cDetail').hidden = false;
  $('#cDetail').dataset.id = id;
  $('#dCity').textContent = c.city;
  $('#dName').textContent = c.name;
  $('#dGroup').textContent = c.group;
  $('#dCount').textContent = `å…± ${c.logs.length} æ¬¡äº’å‹•`;
  $('#dDate').value = todayStr();
  $('#dNote').value = '';
  renderTimeline(c);
  document.getElementById('cDetail').scrollIntoView({behavior:'smooth', block:'start'});
}
function closeDetail(){ $('#cDetail').hidden = true; $('#cDetail').dataset.id=''; }
const dClose = $('#dClose'); if(dClose){ dClose.addEventListener('click', closeDetail); }

function delContact(id){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤äººåŠå…¶æ‰€æœ‰äº’å‹•ç´€éŒ„ï¼Ÿ')) return;
  st.contacts = st.contacts.filter(x=> x.id!==id);
  set('contacts', st.contacts);
  renderContacts();
}

function delLog(id, idx){
  const c = st.contacts.find(x=> x.id===id);
  if(!c) return;
  c.logs.splice(idx,1);
  set('contacts', st.contacts);
  if($('#cDetail').dataset.id===id){ renderTimeline(c); }
  renderContacts();
}

function renderTimeline(c){
  const ul = $('#dTimeline'); ul.innerHTML='';
  const items = [...c.logs].sort((a,b)=> (a.date||'').localeCompare(b.date||''));
  items.forEach((log, i)=>{
    const li = document.createElement('li');
    li.innerHTML = `
      <span class="date">${log.date||''}</span>
      <span>${(log.note||'').replace(/</g,'&lt;')}</span>
      <div style="margin-top:6px">
        <button class="del" onclick="delLog('${c.id.replace(/'/g,"\\'")}', ${i})">åˆªé™¤æ­¤å‰‡</button>
      </div>
    `;
    ul.appendChild(li);
  });
}

function addLogToCurrent(){
  const id = $('#cDetail').dataset.id;
  const c = st.contacts.find(x=> x.id===id);
  if(!c) return;
  const date = $('#dDate').value || todayStr();
  const note = ($('#dNote').value||'').trim();
  if(!note){ alert('è«‹è¼¸å…¥äº’å‹•æƒ…æ³'); return; }
  c.logs.push({date, note});
  set('contacts', st.contacts);
  $('#dNote').value='';
  renderTimeline(c);
  renderContacts();
}
const dAdd = $('#dAdd'); if(dAdd){ dAdd.addEventListener('click', addLogToCurrent); }

function addOrAppendContact(){
  const city = $('#cCity').value;
  const name = ($('#cName').value||'').trim();
  const group = ($('#cGroup').value||'').trim();
  const date = $('#cDate').value || todayStr();
  const note = ($('#cNote').value||'').trim();
  if(!city){ alert('è«‹é¸æ“‡ç¸£å¸‚'); return; }
  if(!name || !group){ alert('è«‹å¡«å¯«å§“åèˆ‡æ—ç¾¤'); return; }
  if(!note){ alert('è«‹è¼¸å…¥äº’å‹•æƒ…æ³'); return; }
  const key = `${city}__${name}__${group}`;
  let c = st.contacts.find(x=> x.id === key);
  if(!c){ c = { id:key, city, name, group, logs:[] }; st.contacts.push(c); }
  c.logs.push({date, note});
  set('contacts', st.contacts);

  // è¨˜ä½å§“å/æ—ç¾¤é¸é …
  maybeAddToOptions(name, group);

  $('#cNote').value='';
  renderContacts();
}
const cAdd = $('#cAdd'); if(cAdd){ cAdd.addEventListener('click', addOrAppendContact); }

function exportPeopleCSV(){
  const lines = ['ç¸£å¸‚,å§“å,æ—ç¾¤,äº’å‹•æ¬¡æ•¸,æœ€è¿‘äº’å‹•æ—¥'];
  st.contacts.forEach(c=>{
    const last = c.logs.length? [...c.logs].sort((a,b)=> (a.date||'').localeCompare(b.date||'')) .slice(-1)[0].date : '';
    lines.push([c.city,c.name,c.group,c.logs.length,last].map(v=>{
      v=String(v??''); return v.includes(',')? `"${v.replace(/"/g,'""')}"`: v;
    }).join(','));
  });
  const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='contacts.csv'; a.click();
}
function exportLogsCSV(){
  const lines = ['ç¸£å¸‚,å§“å,æ—ç¾¤,æ—¥æœŸ,äº’å‹•å…§å®¹'];
  st.contacts.forEach(c=>{
    c.logs.forEach(log=>{
      const row = [c.city,c.name,c.group,log.date||'',log.note||''].map(v=>{
        v=String(v??''); return v.includes(',')? `"${v.replace(/"/g,'""')}"`: v;
      }).join(',');
      lines.push(row);
    });
  });
  const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='contact_logs.csv'; a.click();
}
const cExpPeople = $('#cExpPeople'); if(cExpPeople){ cExpPeople.addEventListener('click', exportPeopleCSV); }
const cExpLogs = $('#cExpLogs'); if(cExpLogs){ cExpLogs.addEventListener('click', exportLogsCSV); }

function renderContacts(){
  const body = $('#cBody'); body.innerHTML='';
  const list = st.contacts.map(c=>{
    const sorted = [...c.logs].sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    const last = sorted.length? sorted[sorted.length-1].date : '';
    return { ...c, count:c.logs.length, last };
  }).sort((a,b)=> (b.last||'').localeCompare(a.last||''));
  const totalLogs = st.contacts.reduce((s,c)=> s + c.logs.length, 0);
  const latest = list.length? (list[0].last || 'â€”') : 'â€”';
  $('#cPeople').textContent = list.length;
  $('#cLogs').textContent = totalLogs;
  $('#cLast').textContent = latest;
  list.forEach((c, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${c.city}</td>
      <td>${c.name}</td>
      <td>${c.group}</td>
      <td>${c.last || 'â€”'}</td>
      <td>${c.count}</td>
      <td>
        <button class="btn" onclick="openContact('${c.id.replace(/'/g,"\\'")}')">æŸ¥çœ‹</button>
        <button class="del" onclick="delContact('${c.id.replace(/'/g,"\\'")}')">åˆªé™¤</button>
      </td>
    `;
    body.appendChild(tr);
  });
  const cur = $('#cDetail').dataset.id;
  if(cur && !st.contacts.find(x=>x.id===cur)){ closeDetail(); }
}

function renderAll(){
  $('#qStart').value=st.qStart||''; $('#qEnd').value=st.qEnd||''; $('#goalBV').value=st.goalBV||1500; $('#goalIBV').value=st.goalIBV||300;
  refreshDatalists();
  renderRecruits(); renderBV(); renderIBV(); renderDashboard(); renderContacts();
}
renderAll();

// è¨»å†Š SWï¼šå›ºå®šç¶²å€ä¹Ÿè‡ªå‹•æ›´æ–°
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }

// Sheet è¡Œå‹•é¢æ¿
window.delRecruit=delRecruit; window.delBV=delBV; window.delIBV=delIBV;
window.openContact=openContact; window.delContact=delContact; window.delLog=delLog;
const sheetEl=document.getElementById('sheet');
function openSheet(){ sheetEl.classList.add('open'); }
function closeSheet(){ sheetEl.classList.remove('open'); }
document.getElementById('openSheet').addEventListener('click', openSheet);
document.getElementById('closeSheet').addEventListener('click', closeSheet);
</script>
</body>
</html>
