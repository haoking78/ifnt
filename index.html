<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IFNT · 無限翻轉人生（穩定版）</title>
<meta name="theme-color" content="#0a2540">
<style>
:root{ --bg:#071a2c; --card:#0b2744; --text:#e9f4ff; --line:rgba(255,255,255,.12); --accent:#42b6ff; --ok:#20d88a; --warn:#ffd166; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,"Noto Sans TC",sans-serif}
header{position:sticky;top:0;z-index:10;padding:10px 12px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(10,37,64,.96),rgba(10,37,64,.7))}
.hbar{max-width:900px;margin:auto;display:flex;gap:10px;align-items:center}
.logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#42b6ff,#8ad4ff);display:grid;place-items:center;color:#002037;font-weight:900;font-size:12px}
.ttl{font-weight:800}
main{max-width:900px;margin:12px auto;padding:0 12px;display:grid;gap:12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--line);border-radius:12px;padding:12px}
h2{margin:0 0 8px}
.grid{display:grid;grid-template-columns:1fr;gap:8px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e3154;color:var(--text)}
.btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:6px} th,td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.1);text-align:center}
.pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 10px}
.ok{color:var(--ok)} .warn{color:var(--warn)}
.progress{height:10px;background:#0c2f52;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,#42b6ff,#8ad4ff);width:0%}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px}
.accordion{background:#0b2b4b;border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:8px}
.timeline{list-style:none;margin:8px 0 0;padding:0}
.timeline li{border-left:2px solid rgba(255,255,255,.15);padding:6px 10px;margin-left:6px;margin-bottom:6px}
.timeline .date{opacity:.8;margin-right:6px}
</style>
</head>
<body>
<header><div class="hbar"><div class="logo">IFNT</div><div class="ttl">IFNT · 無限翻轉人生（穩定版）</div></div></header>
<main>
  <section class="card">
    <h2>季度總覽</h2>
    <div class="grid">
      <div class="row"><div class="pill">季度：<span id="qLabel">未設定</span></div></div>
      <div class="row">
        <div style="flex:1">
          <div>親自招募（目標 1 人）</div><div class="progress"><i id="b1"></i></div>
          <div id="k1" style="margin-top:4px">0 / 1 人</div>
        </div>
        <div style="flex:1">
          <div>零售＋自購（目標 1500 BV）</div><div class="progress"><i id="b2"></i></div>
          <div id="k2" style="margin-top:4px">0 / 1500（差 1500）</div>
        </div>
        <div style="flex:1">
          <div>家庭轉移（目標 300 IBV）</div><div class="progress"><i id="b3"></i></div>
          <div id="k3" style="margin-top:4px">0 / 300（差 300）</div>
        </div>
      </div>
      <div class="row">
        <input id="qStart" type="date"><input id="qEnd" type="date">
        <input id="goalBV" type="number" placeholder="BV 目標（預設 1500）">
        <input id="goalIBV" type="number" placeholder="IBV 目標（預設 300）">
        <button class="btn" id="apply">儲存並套用</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>① 親自招募 1 人</h2>
    <div class="grid">
      <input id="rDate" type="date">
      <input id="rName" type="text" placeholder="招募姓名（必填）">
      <button class="btn" id="rAdd">新增招募</button>
    </div>
    <div class="row" style="margin-top:6px">
      <span class="pill">累計人數：<span id="rCount">0</span>／目標 1</span>
      <span class="pill" id="rStatus">未達標</span>
    </div>
    <table><thead><tr><th>#</th><th>日期</th><th>姓名</th><th>操作</th></tr></thead><tbody id="rBody"></tbody></table>
  </section>

  <section class="card">
    <h2>② 零售＋自購 1500 BV</h2>
    <div class="grid">
      <input id="bDate" type="date">
      <input id="bName" type="text" placeholder="顧客姓名（必填）">
      <input id="bItem" type="text" placeholder="零售品項（自行輸入）">
      <input id="bAmt" type="number" placeholder="BV（必填）">
      <button class="btn" id="bAdd">新增 BV</button>
    </div>
    <table><thead><tr><th>#</th><th>日期</th><th>顧客姓名</th><th>品項</th><th>BV</th><th>操作</th></tr></thead><tbody id="bBody"></tbody></table>
  </section>

  <section class="card">
    <h2>③ 家庭轉移 300 IBV</h2>
    <div class="grid">
      <input id="iDate" type="date">
      <input id="iName" type="text" placeholder="顧客姓名或自己（必填）">
      <input id="iItem" type="text" placeholder="消費品項（自行輸入）">
      <input id="iAmt" type="number" placeholder="IBV（必填）">
      <button class="btn" id="iAdd">新增 IBV</button>
    </div>
    <table><thead><tr><th>#</th><th>日期</th><th>姓名</th><th>品項</th><th>IBV</th><th>操作</th></tr></thead><tbody id="iBody"></tbody></table>
  </section>

  <section class="card">
    <h2>④ 312 互動名單</h2>
    <div class="grid">
      <input id="cCity" type="text" placeholder="居住縣市（必填）">
      <input id="cName" type="text" placeholder="姓名（必填）">
      <input id="cGroup" type="text" placeholder="族群（必填）">
      <input id="cDate" type="date">
      <textarea id="cNote" placeholder="互動情況 / 備註（可寫很多）"></textarea>
      <button class="btn" id="cAdd">新增 / 累加互動</button>
    </div>
    <table><thead><tr><th>#</th><th>縣市</th><th>姓名</th><th>族群</th><th>最近互動日</th><th>次數</th><th>操作</th></tr></thead><tbody id="cBody"></tbody></table>

    <div id="cDetail" class="accordion" hidden>
      <div class="row">
        <span class="badge" id="dCity"></span>
        <span class="badge" id="dName"></span>
        <span class="badge" id="dGroup"></span>
        <span id="dCount"></span>
        <div style="margin-left:auto"></div>
        <button class="btn" id="dClose">收起詳情</button>
      </div>
      <div class="grid">
        <input id="dDate" type="date">
        <textarea id="dNote" placeholder="新增這位的互動紀錄…"></textarea>
        <button class="btn" id="dAdd">新增這位的互動紀錄</button>
      </div>
      <ul class="timeline" id="dTimeline"></ul>
    </div>
  </section>
</main>

<script>
const $ = s => document.querySelector(s);
const nf = new Intl.NumberFormat('zh-Hant',{maximumFractionDigits:0});
const todayStr = () => new Date().toISOString().slice(0,10);
function get(k,d){ try{const v=localStorage.getItem(k); return v? JSON.parse(v): d;}catch(e){ return d; } }
function set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }

const st = {
  qStart: get('qStart',''),
  qEnd: get('qEnd',''),
  goalBV: get('goalBV',1500),
  goalIBV: get('goalIBV',300),
  recruits: get('recruits',[]),
  bvs: get('bvs',[]),
  ibvs: get('ibvs',[]),
  contacts: get('contacts',[])
};

['rDate','bDate','iDate','cDate','dDate'].forEach(id => { const el = $('#'+id); if(el) el.value = todayStr(); });

$('#apply').addEventListener('click', () => {
  st.qStart = $('#qStart').value || st.qStart;
  st.qEnd   = $('#qEnd').value   || st.qEnd;
  st.goalBV = Number($('#goalBV').value || st.goalBV || 1500);
  st.goalIBV= Number($('#goalIBV').value|| st.goalIBV|| 300);
  set('qStart',st.qStart); set('qEnd',st.qEnd); set('goalBV',st.goalBV); set('goalIBV',st.goalIBV);
  renderAll(); alert('設定已儲存');
});

function withinQuarter(dateStr){
  if(!st.qStart || !st.qEnd) return true;
  return dateStr >= st.qStart && dateStr <= st.qEnd;
}

function renderDashboard(){
  const rCnt = st.recruits.filter(x=>withinQuarter(x.date)).length;
  $('#b1').style.width = Math.min(100, rCnt*100) + '%';
  $('#k1').textContent = `${rCnt} / 1 人`;
  $('#rCount').textContent = rCnt;
  $('#rStatus').textContent = rCnt>=1? '已達標':'未達標';
  $('#rStatus').className = 'pill ' + (rCnt>=1? 'ok':'warn');

  const bvSum = st.bvs.filter(x=>withinQuarter(x.date)).reduce((s,x)=> s + (+x.bv||0), 0);
  const bGoal = +st.goalBV || 1500, bRemain = Math.max(0, bGoal - bvSum);
  $('#b2').style.width = Math.min(100, Math.round(bvSum/bGoal*100)) + '%';
  $('#k2').textContent = `${nf.format(bvSum)} / ${bGoal}（差 ${nf.format(bRemain)}）`;

  const ibvSum = st.ibvs.filter(x=>withinQuarter(x.date)).reduce((s,x)=> s + (+x.ibv||0), 0);
  const iGoal = +st.goalIBV || 300, iRemain = Math.max(0, iGoal - ibvSum);
  $('#b3').style.width = Math.min(100, Math.round(ibvSum/iGoal*100)) + '%';
  $('#k3').textContent = `${nf.format(ibvSum)} / ${iGoal}（差 ${nf.format(iRemain)}）`;

  $('#qLabel').textContent = (st.qStart && st.qEnd) ? `${st.qStart} ～ ${st.qEnd}` : '未設定';
}

function renderRecruits(){
  const body = $('#rBody'); body.innerHTML='';
  st.recruits.map((x,i)=>({...x,_i:i})).filter(x=>withinQuarter(x.date)).sort((a,b)=>a.date.localeCompare(b.date)).forEach((x,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${x.date}</td><td>${x.name}</td><td><button class="btn" onclick="delRecruit(${x._i})">刪除</button></td>`;
    body.appendChild(tr);
  });
}

function renderBV(){
  const body = $('#bBody'); body.innerHTML='';
  st.bvs.map((x,i)=>({...x,_i:i})).filter(x=>withinQuarter(x.date)).sort((a,b)=>a.date.localeCompare(b.date)).forEach((x,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${x.date}</td><td>${x.name}</td><td>${x.item||''}</td><td>${nf.format(x.bv)}</td><td><button class="btn" onclick="delBV(${x._i})">刪除</button></td>`;
    body.appendChild(tr);
  });
}

function renderIBV(){
  const body = $('#iBody'); body.innerHTML='';
  st.ibvs.map((x,i)=>({...x,_i:i})).filter(x=>withinQuarter(x.date)).sort((a,b)=>a.date.localeCompare(b.date)).forEach((x,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${x.date}</td><td>${x.name}</td><td>${x.item||''}</td><td>${nf.format(x.ibv)}</td><td><button class="btn" onclick="delIBV(${x._i})">刪除</button></td>`;
    body.appendChild(tr);
  });
}

function addRecruit(){
  const d = $('#rDate').value || todayStr();
  const n = ($('#rName').value||'').trim();
  if(!n){ alert('請輸入招募姓名'); return; }
  st.recruits.push({date:d,name:n}); set('recruits', st.recruits);
  $('#rName').value=''; renderRecruits(); renderDashboard();
}
function delRecruit(i){ st.recruits.splice(i,1); set('recruits', st.recruits); renderRecruits(); renderDashboard(); }

function addBV(){
  const d=$('#bDate').value || todayStr();
  const n=($('#bName').value||'').trim();
  const it=($('#bItem').value||'').trim();
  const v=Number($('#bAmt').value||0);
  if(!n || !v){ alert('請輸入顧客姓名與 BV'); return; }
  st.bvs.push({date:d,name:n,item:it,bv:v}); set('bvs', st.bvs);
  $('#bName').value=''; $('#bItem').value=''; $('#bAmt').value=''; renderBV(); renderDashboard();
}
function delBV(i){ st.bvs.splice(i,1); set('bvs', st.bvs); renderBV(); renderDashboard(); }

function addIBV(){
  const d=$('#iDate').value || todayStr();
  const n=($('#iName').value||'').trim();
  const it=($('#iItem').value||'').trim();
  const v=Number($('#iAmt').value||0);
  if(!n || !v){ alert('請輸入姓名與 IBV'); return; }
  st.ibvs.push({date:d,name:n,item:it,ibv:v}); set('ibvs', st.ibvs);
  $('#iName').value=''; $('#iItem').value=''; $('#iAmt').value=''; renderIBV(); renderDashboard();
}
function delIBV(i){ st.ibvs.splice(i,1); set('ibvs', st.ibvs); renderIBV(); renderDashboard(); }

function openContact(id){
  const c = st.contacts.find(x=>x.id===id); if(!c) return;
  $('#cDetail').hidden = false; $('#cDetail').dataset.id = id;
  $('#dCity').textContent=c.city; $('#dName').textContent=c.name; $('#dGroup').textContent=c.group;
  $('#dCount').textContent=`共 ${c.logs.length} 次互動`;
  $('#dDate').value=todayStr(); $('#dNote').value='';
  renderTimeline(c);
  document.getElementById('cDetail').scrollIntoView({behavior:'smooth',block:'start'});
}
function closeDetail(){ $('#cDetail').hidden=true; $('#cDetail').dataset.id=''; }
function renderTimeline(c){
  const ul = $('#dTimeline'); ul.innerHTML='';
  [...c.logs].sort((a,b)=> (a.date||'').localeCompare(b.date||'')).forEach((log,i)=>{
    const li=document.createElement('li');
    li.innerHTML = `<span class="date">${log.date||''}</span><span>${String(log.note||'').replace(/</g,'&lt;')}</span>`;
    ul.appendChild(li);
  });
}
function addLogToCurrent(){
  const id=$('#cDetail').dataset.id; const c=st.contacts.find(x=>x.id===id); if(!c) return;
  const date=$('#dDate').value || todayStr(); const note=($('#dNote').value||'').trim(); if(!note){ alert('請輸入互動情況'); return; }
  c.logs.push({date, note}); set('contacts', st.contacts); $('#dNote').value=''; renderTimeline(c); renderContacts();
}
function addOrAppendContact(){
  const city=($('#cCity').value||'').trim();
  const name=($('#cName').value||'').trim();
  const group=($('#cGroup').value||'').trim();
  const date=$('#cDate').value || todayStr();
  const note=($('#cNote').value||'').trim();
  if(!city || !name || !group){ alert('請填寫「縣市／姓名／族群」'); return; }
  if(!note){ alert('請輸入互動情況'); return; }
  const key=`${city}__${name}__${group}`;
  let c=st.contacts.find(x=>x.id===key);
  if(!c){ c={id:key, city,name,group,logs:[]}; st.contacts.push(c); }
  c.logs.push({date, note}); set('contacts', st.contacts);
  $('#cNote').value=''; renderContacts();
}
function renderContacts(){
  const body=$('#cBody'); body.innerHTML='';
  const list=st.contacts.map(c=>{
    const sorted=[...c.logs].sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    const last=sorted.length? sorted[sorted.length-1].date : '';
    return {...c, count:c.logs.length, last};
  }).sort((a,b)=> (b.last||'').localeCompare(a.last||''));
  list.forEach((c,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx+1}</td><td>${c.city}</td><td>${c.name}</td><td>${c.group}</td><td>${c.last||'—'}</td><td>${c.count}</td>
    <td><button class="btn" onclick="openContact('${c.id.replace(/'/g,"\\'")}')">查看</button></td>`;
    body.appendChild(tr);
  });
  if($('#cDetail').dataset.id && !st.contacts.find(x=>x.id===$('#cDetail').dataset.id)){ closeDetail(); }
}
$('#rAdd').addEventListener('click', addRecruit);
$('#bAdd').addEventListener('click', addBV);
$('#iAdd').addEventListener('click', addIBV);
$('#cAdd').addEventListener('click', addOrAppendContact);
$('#dAdd').addEventListener('click', addLogToCurrent);
$('#dClose').addEventListener('click', closeDetail);

function renderAll(){
  renderDashboard(); renderRecruits(); renderBV(); renderIBV(); renderContacts();
}
renderAll();
</script>
</body>
</html>
