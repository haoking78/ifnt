const storeKey='ifnt_data_v62';const $=(s,p=document)=>p.querySelector(s);const $$=(s,p=document)=>[...p.querySelectorAll(s)];const todayStr=()=>new Date().toISOString().slice(0,10);
const defaultData={version:'6.2',goals:{recruit:1,bv:1500,ibv:300},recruit:{list:[]},retail:{list:[]},family:{list:[]},contacts:{order:[],index:{}}};
function load(){try{const j=localStorage.getItem(storeKey);if(!j)return structuredClone(defaultData);const d=JSON.parse(j);d.goals??={recruit:1,bv:1500,ibv:300};d.recruit??={list:[]};d.retail??={list:[]};d.family??={list:[]};d.contacts??={order:[],index:{}};return d}catch(e){return structuredClone(defaultData)}}
function save(){localStorage.setItem(storeKey,JSON.stringify(DB))}let DB=load();
function setActive(tab){$$("#tabs .chip").forEach(c=>c.classList.toggle('active',c.dataset.tab===tab));$$(".tab").forEach(t=>t.style.display=(t.id==='tab-'+tab?'':'none'))}
$("#tabs").addEventListener('click',e=>{const chip=e.target.closest('.chip');if(!chip)return;setActive(chip.dataset.tab)});
// Recruit
const recTbody=$("#recTbody");function renderRecruit(){$("#recGoal").textContent=DB.goals.recruit;$("#recTotal").textContent=DB.recruit.list.length;recTbody.innerHTML=DB.recruit.list.map((r,i)=>`<tr><td>${i+1}</td><td>${r.date}</td><td>${r.name}</td><td><button class="btn ghost" data-del="${i}">åˆªé™¤</button></td></tr>`).join('');const ok=DB.recruit.list.length>=DB.goals.recruit;const p=$("#recStatus");p.textContent=ok?"ðŸŽ‰ å·²é”æ¨™":"å°šæœªé”æ¨™";p.className="pill "+(ok?"oktxt":"")}
recTbody.addEventListener('click',e=>{const idx=e.target.dataset.del;if(idx!==undefined){DB.recruit.list.splice(+idx,1);save();renderRecruit()}});
$("#btnRecAdd").addEventListener('click',()=>{const date=$("#recDate").value||todayStr();const name=$("#recName").value.trim();if(!name){alert("è«‹è¼¸å…¥å§“å");return}DB.recruit.list.push({date,name});save();$("#recName").value="";$("#recDate").value="";renderRecruit()});
// Retail
const retTbody=$("#retTbody");function renderRetail(){const sum=DB.retail.list.reduce((a,b)=>a+Number(b.bv||0),0);$("#retGoal").textContent=DB.goals.bv;$("#retTotal").textContent=sum;const remain=Math.max(0,DB.goals.bv-sum);$("#retRemain").textContent=remain===0?"ðŸŽ‰ å·²é”æ¨™":`å°šå·® ${remain}`;retTbody.innerHTML=DB.retail.list.map((r,i)=>`<tr><td>${i+1}</td><td>${r.date}</td><td>${(r.customer||'')}${r.item?'ï½œ'+r.item:''}</td><td class="right">${r.bv}</td><td><button class="btn ghost" data-del="${i}">åˆªé™¤</button></td></tr>`).join('')}
retTbody.addEventListener('click',e=>{const idx=e.target.dataset.del;if(idx!==undefined){DB.retail.list.splice(+idx,1);save();renderRetail()}});
$("#btnRetAdd").addEventListener('click',()=>{const date=$("#retDate").value||todayStr();const customer=$("#retCustomer").value.trim();const item=$("#retItem").value.trim();const bv=Number($("#retBV").value||0);if(bv<=0){alert("è«‹è¼¸å…¥ BV æ•¸å­—");return}DB.retail.list.push({date,customer,item,bv});save();$("#retDate").value=$("#retCustomer").value=$("#retItem").value=$("#retBV").value="";renderRetail()});
// Family
const famTbody=$("#famTbody");function renderFamily(){const sum=DB.family.list.reduce((a,b)=>a+Number(b.ibv||0),0);$("#famGoal").textContent=DB.goals.ibv;$("#famTotal").textContent=sum;const remain=Math.max(0,DB.goals.ibv-sum);$("#famRemain").textContent=remain===0?"ðŸŽ‰ å·²é”æ¨™":`å°šå·® ${remain}`;famTbody.innerHTML=DB.family.list.map((r,i)=>`<tr><td>${i+1}</td><td>${r.date}</td><td>${(r.person||'')}${r.item?'ï½œ'+r.item:''}</td><td class="right">${r.ibv}</td><td><button class="btn ghost" data-del="${i}">åˆªé™¤</button></td></tr>`).join('')}
famTbody.addEventListener('click',e=>{const idx=e.target.dataset.del;if(idx!==undefined){DB.family.list.splice(+idx,1);save();renderFamily()}});
$("#btnFamAdd").addEventListener('click',()=>{const date=$("#famDate").value||todayStr();const person=$("#famPerson").value.trim();const item=$("#famItem").value.trim();const ibv=Number($("#famIBV").value||0);if(ibv<=0){alert("è«‹è¼¸å…¥ IBV æ•¸å­—");return}DB.family.list.push({date,person,item,ibv});save();$("#famDate").value=$("#famPerson").value=$("#famItem").value=$("#famIBV").value="";renderFamily()});
// Contacts
const cities=["åŸºéš†å¸‚","è‡ºåŒ—å¸‚","æ–°åŒ—å¸‚","æ¡ƒåœ’å¸‚","æ–°ç«¹å¸‚","æ–°ç«¹ç¸£","è‹—æ —ç¸£","è‡ºä¸­å¸‚","å½°åŒ–ç¸£","å—æŠ•ç¸£","é›²æž—ç¸£","å˜‰ç¾©å¸‚","å˜‰ç¾©ç¸£","è‡ºå—å¸‚","é«˜é›„å¸‚","å±æ±ç¸£","å®œè˜­ç¸£","èŠ±è“®ç¸£","è‡ºæ±ç¸£","æ¾Žæ¹–ç¸£","é‡‘é–€ç¸£","é€£æ±Ÿç¸£"];const citySel=$("#ctCity");citySel.innerHTML=cities.map(c=>`<option value="${c}">${c}</option>`).join('');
const ctTbody=$("#ctTbody");function renderContacts(){const rows=DB.contacts.order.map((name,i)=>{const it=DB.contacts.index[name];const last=it.logs.length?it.logs[it.logs.length-1].date:"-";return `<tr><td>${i+1}</td><td>${it.city||""}</td><td>${name}</td><td>${it.group||""}</td><td>${last}</td><td class="right">${it.logs.length}</td><td><button class="btn ghost" data-view="${name}">æŸ¥çœ‹</button> <button class="btn ghost" data-del="${name}">åˆªé™¤</button></td></tr>`}).join('');ctTbody.innerHTML=rows||`<tr><td colspan="7" style="opacity:.7">å°šç„¡è³‡æ–™</td></tr>`}
ctTbody.addEventListener('click',e=>{const v=e.target.dataset.view;const d=e.target.dataset.del;if(v){const it=DB.contacts.index[v];const detail=it.logs.map(l=>`${l.date}ï½œ${l.note}`).join('\n');alert(`ã€${v}ã€‘(${it.city}ï½œ${it.group||''}) äº’å‹•ç´€éŒ„ï¼š\n`+(detail||'å°šç„¡'))}if(d){if(confirm(`åˆªé™¤ã€Œ${d}ã€æ•´ç­†åå–®èˆ‡æ‰€æœ‰äº’å‹•ï¼Ÿ`)){delete DB.contacts.index[d];DB.contacts.order=DB.contacts.order.filter(n=>n!==d);save();renderContacts()}}});
$("#btnCtAdd").addEventListener('click',()=>{const city=$("#ctCity").value;const name=$("#ctName").value.trim();const group=$("#ctGroup").value.trim();const date=$("#ctDate").value||todayStr();const note=$("#ctNote").value.trim();if(!name){alert("è«‹è¼¸å…¥å§“å");return}if(!DB.contacts.index[name]){DB.contacts.index[name]={city,group,logs:[]};DB.contacts.order.push(name)}DB.contacts.index[name].city=city;if(group)DB.contacts.index[name].group=group;DB.contacts.index[name].logs.push({date,note});save();$("#ctName").value=$("#ctGroup").value=$("#ctNote").value=$("#ctDate").value="";renderContacts()});
$("#btnCtClear").addEventListener('click',()=>{$("#ctName").value=$("#ctGroup").value=$("#ctNote").value=$("#ctDate").value=""});
// Export CSV
$("#btnExport").addEventListener('click',()=>{let out=[];out.push('=== æ‹›å‹Ÿ 1 äºº ===');out.push('æ—¥æœŸ,å§“å');DB.recruit.list.forEach(r=>out.push(`${r.date},${r.name}`));out.push('');out.push('=== é›¶å”®ï¼‹è‡ªè³¼ 1500 BV ===');out.push('æ—¥æœŸ,é¡§å®¢,å“é …,BV');DB.retail.list.forEach(r=>out.push(`${r.date},${r.customer||''},${r.item||''},${r.bv}`));out.push('');out.push('=== å®¶åº­è½‰ç§» 300 IBV ===');out.push('æ—¥æœŸ,å°è±¡,å“é …,IBV');DB.family.list.forEach(r=>out.push(`${r.date},${r.person||''},${r.item||''},${r.ibv}`));out.push('');out.push('=== 312 äº’å‹•åå–® ===');out.push('å§“å,ç¸£å¸‚,æ—ç¾¤,æœ€è¿‘äº’å‹•,æ¬¡æ•¸,æ‰€æœ‰äº’å‹•(æ—¥æœŸï½œå…§å®¹ï¼›â€¦)');DB.contacts.order.forEach(name=>{const it=DB.contacts.index[name];const last=it.logs.length?it.logs[it.logs.length-1].date:'';const joined=it.logs.map(x=>`${x.date}ï½œ${(x.note||'').replace(/,/g,'ã€')}`).join('ï¼›');out.push(`${name},${it.city||''},${it.group||''},${last},${it.logs.length},${joined}`)});const blob=new Blob([out.join('\n')],{type:'text/csv;charset=utf-8'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`IFNT_export_${new Date().toISOString().slice(0,10)}.csv`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)});
// Clear, PWA
$("#btnClearAll").addEventListener('click',()=>{if(!confirm("ç¢ºå®šè¦æ¸…ç©ºæœ¬æ©Ÿæ‰€æœ‰è³‡æ–™å—Žï¼Ÿ"))return;localStorage.removeItem(storeKey);DB=load();renderAll()});
let deferredPrompt;window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e});$("#btnInstall").addEventListener('click',async()=>{if(deferredPrompt){deferredPrompt.prompt();deferredPrompt=null}else alert("è‹¥æœªå‡ºç¾å®‰è£æç¤ºï¼Œå¯ç”¨ç€è¦½å™¨ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚")});
function renderAll(){$("#recDate").value=$("#retDate").value=$("#famDate").value=$("#ctDate").value=todayStr();renderRecruit();renderRetail();renderFamily();renderContacts()}
renderAll();
if('serviceWorker'in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./service-worker.js')})}
